<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø–æ—Å—Ç—É</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç–∫–∞ —Å —Å–∞–π–¥–±–∞—Ä–æ–º */
        .main-layout {
            margin-left: 280px;
            min-height: 100vh;
            display: flex;
            background-color: #f8f9fa;
        }

        .content-area {
            flex: 1;
            padding: 20px;
            max-width: calc(100% - 320px);
        }

        .aside-section {
            width: 320px;
            padding: 20px 20px 20px 0;
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        /* –°—Ç–∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ */
        .comment-item {
            border-bottom: 1px solid #e9ecef;
            padding: 15px 0;
        }

        .comment-item:last-child {
            border-bottom: none;
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .comment-content {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 8px;
        }

        .comment-actions {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .comment-form {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .post-info {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .post-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .error {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        .success {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        .edit-form {
            display: none;
            margin-top: 10px;
        }

        .btn-sm {
            font-size: 0.75rem;
            padding: 2px 8px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è aside –≤–∏–¥–∂–µ—Ç–æ–≤ */
        .widget {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
        }

        .widget-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .widget-title i {
            margin-right: 8px;
            color: #2563eb;
        }

        .latest-comment {
            display: flex;
            align-items: start;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .latest-comment:last-child {
            border-bottom: none;
        }

        .latest-comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        .latest-comment-content {
            flex: 1;
        }

        .latest-comment-author {
            font-weight: 500;
            font-size: 0.875rem;
            color: #333;
        }

        .latest-comment-text {
            font-size: 0.8rem;
            color: #666;
            margin: 2px 0;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .latest-comment-time {
            font-size: 0.75rem;
            color: #999;
        }

        .post-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .post-stats:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #666;
        }

        .stat-value {
            font-weight: 600;
            color: #333;
        }

        .author-card {
            text-align: center;
        }

        .author-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            object-fit: cover;
            border: 3px solid #e9ecef;
        }

        .author-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .author-followers {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 15px;
        }

        .follow-btn {
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .follow-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 1200px) {
            .aside-section {
                display: none;
            }

            .content-area {
                max-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .main-layout {
                margin-left: 0;
                padding-top: 60px;
            }

            .content-area {
                padding: 15px;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∞–π–¥–±–∞—Ä –∏–∑ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ -->
<div th:replace="~{fragments/sidebar :: complete-sidebar('comments')}"></div>

<div class="main-layout">
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="content-area">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ—Å—Ç–µ -->
        <div class="post-info" th:if="${post}">
            <div class="d-flex align-items-start">
                <img th:src="${post.author.imageUrl}"
                     th:alt="${post.author.firstName + ' ' + post.author.lastName}"
                     class="comment-avatar me-3"
                     onerror="this.src='/images/default-avatar.png'">
                <div class="flex-grow-1">
                    <h5 class="mb-1" th:text="${post.author.firstName + ' ' + post.author.lastName}">–ê–≤—Ç–æ—Ä</h5>
                    <small class="text-muted"
                           th:text="${#temporals.format(post.createdAt, 'dd.MM.yyyy HH:mm')}">–î–∞—Ç–∞</small>
                </div>
            </div>

            <div class="mt-3">
                <p th:text="${post.content}" class="mb-3">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–∞</p>
                <img th:if="${post.imageUrl}"
                     th:src="${post.imageUrl}"
                     class="post-image mb-3"
                     alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å—Ç–∞">
            </div>

            <div class="d-flex justify-content-between text-muted">
                <span><i class="fas fa-heart"></i> <span th:text="${post.likesCount}">0</span> –ª–∞–π–∫–æ–≤</span>
                <span><i class="fas fa-comment"></i> <span id="total-comments" th:text="${totalComments}">0</span> –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</span>
                <span><i class="fas fa-eye"></i> <span th:text="${post.viewsCount}">0</span> –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</span>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
        <div class="comment-form" th:if="${currentUser}">
            <h5 class="mb-3">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h5>
            <form id="comment-form">
                <div class="mb-3">
                        <textarea id="comment-content"
                                  class="form-control"
                                  rows="3"
                                  placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
                                  required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </form>
        </div>




        <!-- AI –ü–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
        <div class="ai-assistant-section" th:if="${currentUser}" style="margin-top: 20px;">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-robot"></i> AI –ü–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                        <span class="badge bg-light text-primary ms-2" id="ai-status-badge">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="ai-prompt" class="form-label">–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å?</label>
                                <input type="text"
                                       id="ai-prompt"
                                       class="form-control"
                                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ω–∞–ø–∏—à–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤ –æ —Å—Ç–∞—Ç—å–µ"
                                       maxlength="200">
                                <div class="form-text">–û–ø–∏—à–∏—Ç–µ, –∫–∞–∫–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">–¢–∏–ø –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è</label>
                            <select id="comment-type" class="form-select">
                                <option value="GENERAL">–û–±—â–∏–π</option>
                                <option value="POSITIVE">–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π</option>
                                <option value="QUESTION">–í–æ–ø—Ä–æ—Å</option>
                                <option value="CONSTRUCTIVE">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–π</option>
                                <option value="TECHNICAL">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π</option>
                                <option value="CREATIVE">–ö—Ä–µ–∞—Ç–∏–≤–Ω—ã–π</option>
                            </select>
                        </div>
                    </div>

                    <div class="d-flex gap-2 mb-3">
                        <button type="button" class="btn btn-outline-primary" onclick="generateCommentPreview()">
                            <i class="fas fa-eye"></i> –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                        </button>
                        <button type="button" class="btn btn-primary" onclick="generateAndPostComment()">
                            <i class="fas fa-magic"></i> –°–æ–∑–¥–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="showAITemplates()">
                            <i class="fas fa-list"></i> –®–∞–±–ª–æ–Ω—ã
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="showAIExamples()">
                            <i class="fas fa-lightbulb"></i> –ü—Ä–∏–º–µ—Ä—ã
                        </button>
                    </div>

                    <!-- –ü—Ä–µ–≤—å—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                    <div id="ai-preview-section" style="display: none;">
                        <div class="alert alert-info">
                            <strong>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:</strong>
                            <div id="ai-preview-text" style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px;"></div>
                            <div class="mt-2">
                                <button class="btn btn-success btn-sm" onclick="useGeneratedComment()">
                                    <i class="fas fa-check"></i> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="hidePreview()">
                                    <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- –°—Ç–∞—Ç—É—Å AI -->
                    <div id="ai-loading" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                            <span>AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —à–∞–±–ª–æ–Ω–æ–≤ -->
        <div class="modal fade" id="templatesModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-list"></i> –®–∞–±–ª–æ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="templates-content">
                            <div class="text-center">
                                <div class="spinner-border text-primary"></div>
                                <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–º–µ—Ä–æ–≤ -->
        <div class="modal fade" id="examplesModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-lightbulb"></i> –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–º–ø—Ç–æ–≤
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="examples-content">
                            <div class="text-center">
                                <div class="spinner-border text-primary"></div>
                                <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–º–µ—Ä–æ–≤...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ª—É—á—à–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
        <div class="modal fade" id="improveModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-magic"></i> –£–ª—É—á—à–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="improve-text" class="form-label">–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                            <textarea id="improve-text" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="improve-type" class="form-label">–¢–∏–ø —É–ª—É—á—à–µ–Ω–∏—è:</label>
                            <select id="improve-type" class="form-select">
                                <option value="GENERAL">–û–±—â–µ–µ —É–ª—É—á—à–µ–Ω–∏–µ</option>
                                <option value="GRAMMAR">–ò—Å–ø—Ä–∞–≤–∏—Ç—å –≥—Ä–∞–º–º–∞—Ç–∏–∫—É</option>
                                <option value="TONE">–£–ª—É—á—à–∏—Ç—å —Ç–æ–Ω</option>
                                <option value="CLARITY">–ü–æ–≤—ã—Å–∏—Ç—å —è—Å–Ω–æ—Å—Ç—å</option>
                                <option value="POLITENESS">–°–¥–µ–ª–∞—Ç—å –≤–µ–∂–ª–∏–≤–µ–µ</option>
                            </select>
                        </div>
                        <div id="improve-result" style="display: none;">
                            <div class="alert alert-success">
                                <strong>–£–ª—É—á—à–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:</strong>
                                <div id="improved-text" style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="button" class="btn btn-primary" onclick="improveComment()">
                            <i class="fas fa-magic"></i> –£–ª—É—á—à–∏—Ç—å
                        </button>
                        <button type="button" class="btn btn-success" onclick="useImprovedComment()" style="display: none;" id="use-improved-btn">
                            <i class="fas fa-check"></i> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è AI
            let aiServiceAvailable = false;
            let lastGeneratedComment = '';
            let commentToImprove = '';

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AI —Ñ—É–Ω–∫—Ü–∏–π
            document.addEventListener('DOMContentLoaded', function() {
                checkAIServiceStatus();
                addImproveButtonsToComments();
            });

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ AI —Å–µ—Ä–≤–∏—Å–∞
            async function checkAIServiceStatus() {
                try {
                    const response = await fetch(`/api/posts/${postId}/comments/ai/status`);
                    const data = await response.json();

                    aiServiceAvailable = data.aiServiceAvailable;

                    const statusBadge = document.getElementById('ai-status-badge');
                    const aiSection = document.querySelector('.ai-assistant-section');

                    if (aiServiceAvailable) {
                        statusBadge.textContent = '–ì–æ—Ç–æ–≤';
                        statusBadge.className = 'badge bg-success text-white ms-2';
                        aiSection.style.display = 'block';
                    } else {
                        statusBadge.textContent = '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                        statusBadge.className = 'badge bg-danger text-white ms-2';
                        aiSection.style.opacity = '0.6';
                        aiSection.style.pointerEvents = 'none';
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ AI —Å–µ—Ä–≤–∏—Å–∞:', error);
                    document.getElementById('ai-status-badge').textContent = '–û—à–∏–±–∫–∞';
                    document.getElementById('ai-status-badge').className = 'badge bg-warning text-dark ms-2';
                }
            }

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
            async function generateCommentPreview() {
                const prompt = document.getElementById('ai-prompt').value.trim();
                const commentType = document.getElementById('comment-type').value;

                if (!prompt) {
                    showError('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∂–µ–ª–∞–µ–º–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
                    return;
                }

                if (!aiServiceAvailable) {
                    showError('AI —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                    return;
                }

                showAILoading(true);
                hidePreview();

                try {
                    const response = await fetch(`/api/posts/${postId}/comments/ai/preview`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            commentType: commentType
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        lastGeneratedComment = data.data.generatedComment;
                        document.getElementById('ai-preview-text').textContent = lastGeneratedComment;
                        document.getElementById('ai-preview-section').style.display = 'block';
                        showSuccess('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω! –í—Ä–µ–º—è: ' + data.data.generationTimeMs + ' –º—Å');
                    } else {
                        showError('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + data.error);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + error.message);
                } finally {
                    showAILoading(false);
                }
            }

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
            async function generateAndPostComment() {
                const prompt = document.getElementById('ai-prompt').value.trim();
                const commentType = document.getElementById('comment-type').value;

                if (!prompt) {
                    showError('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∂–µ–ª–∞–µ–º–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
                    return;
                }

                if (!aiServiceAvailable) {
                    showError('AI —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                    return;
                }

                if (!confirm('–°–æ–∑–¥–∞—Ç—å –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –ø–æ–º–æ—â—å—é AI?')) {
                    return;
                }

                showAILoading(true);
                hidePreview();

                try {
                    const response = await fetch(`/api/posts/${postId}/comments/ai/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            commentType: commentType
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showSuccess('AI –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!');

                        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                        document.getElementById('ai-prompt').value = '';
                        document.getElementById('comment-type').value = 'GENERAL';

                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                        updateCommentsCount();
                        loadLatestComments();
                        loadComments(0); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

                    } else {
                        showError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + data.error);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + error.message);
                } finally {
                    showAILoading(false);
                }
            }

            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
            function useGeneratedComment() {
                if (lastGeneratedComment) {
                    document.getElementById('comment-content').value = lastGeneratedComment;
                    hidePreview();
                    showSuccess('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ñ–æ—Ä–º—É. –ù–∞–∂–º–∏—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.');

                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                    document.getElementById('comment-content').scrollIntoView({ behavior: 'smooth' });
                    document.getElementById('comment-content').focus();
                }
            }

            // –°–∫—Ä—ã—Ç–∏–µ –ø—Ä–µ–≤—å—é
            function hidePreview() {
                document.getElementById('ai-preview-section').style.display = 'none';
            }

            // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ AI
            function showAILoading(show) {
                document.getElementById('ai-loading').style.display = show ? 'block' : 'none';
            }

            // –ü–æ–∫–∞–∑ —à–∞–±–ª–æ–Ω–æ–≤
            async function showAITemplates() {
                const modal = new bootstrap.Modal(document.getElementById('templatesModal'));
                modal.show();

                try {
                    const response = await fetch(`/api/posts/${postId}/comments/ai/templates`);
                    const data = await response.json();

                    if (data.success) {
                        let templatesHtml = '<div class="row">';

                        Object.entries(data.templates).forEach(([key, template]) => {
                            templatesHtml += `
          <div class="col-md-6 mb-3">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title text-capitalize">${key.replace('_', ' ')}</h6>
                <p class="card-text small text-muted">${template.example}</p>
                <button class="btn btn-sm btn-primary" onclick="useTemplate('${template.prompt}')">
                  <i class="fas fa-copy"></i> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
                </button>
              </div>
            </div>
          </div>
        `;
                        });

                        templatesHtml += '</div>';
                        templatesHtml += `<div class="alert alert-info mt-3"><i class="fas fa-info-circle"></i> ${data.usage}</div>`;

                        document.getElementById('templates-content').innerHTML = templatesHtml;
                    }
                } catch (error) {
                    document.getElementById('templates-content').innerHTML =
                        '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤</div>';
                }
            }

            // –ü–æ–∫–∞–∑ –ø—Ä–∏–º–µ—Ä–æ–≤
            async function showAIExamples() {
                const modal = new bootstrap.Modal(document.getElementById('examplesModal'));
                modal.show();

                try {
                    const response = await fetch(`/api/posts/${postId}/comments/ai/examples`);
                    const data = await response.json();

                    if (data.success) {
                        let examplesHtml = '<div class="row">';

                        Object.entries(data.examples).forEach(([key, example]) => {
                            examplesHtml += `
          <div class="col-md-6 mb-3">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title text-capitalize">${key}</h6>
                <p class="card-text">"${example.prompt}"</p>
                <small class="text-muted">${example.description}</small>
                <div class="mt-2">
                  <button class="btn btn-sm btn-primary" onclick="useExample('${example.prompt}', '${key.toUpperCase()}')">
                    <i class="fas fa-copy"></i> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
                        });

                        examplesHtml += '</div>';

                        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–≤–µ—Ç—ã
                        if (data.tips) {
                            examplesHtml += '<div class="alert alert-info mt-3"><h6>üí° –°–æ–≤–µ—Ç—ã:</h6><ul class="mb-0">';
                            Object.entries(data.tips).forEach(([key, tip]) => {
                                examplesHtml += `<li><strong>${key}:</strong> ${tip}</li>`;
                            });
                            examplesHtml += '</ul></div>';
                        }

                        document.getElementById('examples-content').innerHTML = examplesHtml;
                    }
                } catch (error) {
                    document.getElementById('examples-content').innerHTML =
                        '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–º–µ—Ä–æ–≤</div>';
                }
            }

            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
            function useTemplate(prompt) {
                document.getElementById('ai-prompt').value = prompt;
                bootstrap.Modal.getInstance(document.getElementById('templatesModal')).hide();
                showSuccess('–®–∞–±–ª–æ–Ω –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø–æ–ª–µ –ø—Ä–æ–º–ø—Ç–∞');
            }

            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–∞
            function useExample(prompt, type) {
                document.getElementById('ai-prompt').value = prompt;
                document.getElementById('comment-type').value = type;
                bootstrap.Modal.getInstance(document.getElementById('examplesModal')).hide();
                showSuccess('–ü—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ñ–æ—Ä–º—É');
            }

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —É–ª—É—á—à–µ–Ω–∏—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º
            function addImproveButtonsToComments() {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é renderCommentActions
                const originalRenderCommentActions = window.renderCommentActions;
                window.renderCommentActions = function(comment) {
                    if (!currentUser) return '';

                    const isOwner = currentUser.id === comment.author.id;
                    let actions = '';

                    if (isOwner) {
                        actions += `
        <button class="btn btn-sm btn-outline-primary me-2" onclick="editComment(${comment.id})">
          <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </button>
        <button class="btn btn-sm btn-outline-danger me-2" onclick="deleteComment(${comment.id})">
          <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
        </button>
      `;
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                    if (aiServiceAvailable) {
                        actions += `
        <button class="btn btn-sm btn-outline-info" onclick="showImproveModal('${comment.content.replace(/'/g, "\\'")}')">
          <i class="fas fa-magic"></i> –£–ª—É—á—à–∏—Ç—å —Å AI
        </button>
      `;
                    }

                    return actions ? `<div class="comment-actions mt-2">${actions}</div>` : '';
                };
            }

            // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–ª—É—á—à–µ–Ω–∏—è
            function showImproveModal(commentText) {
                commentToImprove = commentText;
                document.getElementById('improve-text').value = commentText;
                document.getElementById('improve-result').style.display = 'none';
                document.getElementById('use-improved-btn').style.display = 'none';

                const modal = new bootstrap.Modal(document.getElementById('improveModal'));
                modal.show();
            }

            // –£–ª—É—á—à–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
            async function improveComment() {
                const originalComment = document.getElementById('improve-text').value.trim();
                const improvementType = document.getElementById('improve-type').value;

                if (!originalComment) {
                    showError('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è');
                    return;
                }

                try {
                    const response = await fetch(`/api/posts/${postId}/comments/ai/improve`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            originalComment: originalComment,
                            improvementType: improvementType
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        document.getElementById('improved-text').textContent = data.data.generatedComment;
                        document.getElementById('improve-result').style.display = 'block';
                        document.getElementById('use-improved-btn').style.display = 'inline-block';
                        showSuccess('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–ª—É—á—à–µ–Ω –∑–∞ ' + data.data.generationTimeMs + ' –º—Å');
                    } else {
                        showError('–û—à–∏–±–∫–∞ —É–ª—É—á—à–µ–Ω–∏—è: ' + data.error);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–ª—É—á—à–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + error.message);
                }
            }

            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
            function useImprovedComment() {
                const improvedText = document.getElementById('improved-text').textContent;
                document.getElementById('comment-content').value = improvedText;

                bootstrap.Modal.getInstance(document.getElementById('improveModal')).hide();
                showSuccess('–£–ª—É—á—à–µ–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ñ–æ—Ä–º—É');

                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ
                document.getElementById('comment-content').scrollIntoView({ behavior: 'smooth' });
                document.getElementById('comment-content').focus();
            }

            // –î–æ–±–∞–≤–ª—è–µ–º CSS —Å—Ç–∏–ª–∏ –¥–ª—è AI —Å–µ–∫—Ü–∏–∏
            const aiStyles = `
<style>
.ai-assistant-section {
  margin-top: 20px;
  animation: slideIn 0.3s ease-in-out;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

#ai-preview-section {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.card {
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: box-shadow 0.3s ease;
}

.card:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.btn {
  transition: all 0.2s ease;
}

.btn:hover {
  transform: translateY(-1px);
}

.ai-template-card {
  cursor: pointer;
  transition: transform 0.2s ease;
}

.ai-template-card:hover {
  transform: scale(1.02);
}

</style>
`;

            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –≤ head
            document.head.insertAdjacentHTML('beforeend', aiStyles);

            console.log('ü§ñ AI –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
        </script>










        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div class="alert alert-info" th:unless="${currentUser}">
            <i class="fas fa-info-circle"></i>
            –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="notifications"></div>

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (<span id="comments-count" th:text="${totalComments}">0</span>)</h4>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="sortComments('newest')">
                    <i class="fas fa-sort-amount-down"></i> –ù–æ–≤—ã–µ
                </button>
                <button class="btn btn-outline-secondary" onclick="sortComments('oldest')">
                    <i class="fas fa-sort-amount-up"></i> –°—Ç–∞—Ä—ã–µ
                </button>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
        <div id="comments-container">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...
            </div>
        </div>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        <nav aria-label="–ü–∞–≥–∏–Ω–∞—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤" class="mt-4">
            <ul id="pagination" class="pagination justify-content-center">
                <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ JavaScript -->
            </ul>
        </nav>
    </div>

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <aside class="aside-section">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ—Ä–µ –ø–æ—Å—Ç–∞ -->
        <div class="widget" th:if="${post}">
            <div class="widget-title">
                <i class="fas fa-user"></i>
                –ê–≤—Ç–æ—Ä –ø–æ—Å—Ç–∞
            </div>
            <div class="author-card">
                <img th:src="${post.author.imageUrl}"
                     th:alt="${post.author.firstName + ' ' + post.author.lastName}"
                     class="author-avatar"
                     onerror="this.src='/images/default-avatar.png'">
                <div class="author-name" th:text="${post.author.firstName + ' ' + post.author.lastName}">–ò–º—è –∞–≤—Ç–æ—Ä–∞
                </div>
                <div class="author-followers">1.2K –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</div>
                <!--        <button class="follow-btn" th:if="${currentUser and currentUser.id != post.author.id}">-->
                <!--          <i class="fas fa-plus"></i> –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è-->
                <!--        </button>-->
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å—Ç–∞ -->
        <div class="widget" th:if="${post}">
            <div class="widget-title">
                <i class="fas fa-chart-bar"></i>
                –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </div>
            <div class="post-stats">
                <span class="stat-label">–õ–∞–π–∫–∏</span>
                <span class="stat-value" th:text="${post.likesCount}">0</span>
            </div>
            <div class="post-stats">
                <span class="stat-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</span>
                <span class="stat-value" id="sidebar-comments-count" th:text="${totalComments}">0</span>
            </div>
            <div class="post-stats">
                <span class="stat-label">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</span>
                <span class="stat-value" th:text="${post.viewsCount}">0</span>
            </div>
            <div class="post-stats">
                <span class="stat-label">–°–æ–∑–¥–∞–Ω</span>
                <span class="stat-value" th:text="${#temporals.format(post.createdAt, 'dd.MM.yyyy')}">01.01.2024</span>
            </div>
        </div>

        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
        <div class="widget">
            <div class="widget-title">
                <i class="fas fa-comments"></i>
                –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            </div>
            <div id="latest-comments-widget">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
            </div>
        </div>

        <!-- –ü–æ—Ö–æ–∂–∏–µ –ø–æ—Å—Ç—ã -->
        <div class="widget">
            <div class="widget-title">
                <i class="fas fa-bookmark"></i>
                –î–µ–π—Å—Ç–≤–∏—è
            </div>
            <div class="d-grid gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="sharePost()">
                    <i class="fas fa-share"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="reportPost()">
                    <i class="fas fa-flag"></i> –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è
                </button>
                <a th:href="@{'/posts/' + ${postId}}" class="btn btn-outline-info btn-sm">
                    <i class="fas fa-arrow-left"></i> –ö –ø–æ—Å—Ç—É
                </a>
            </div>
        </div>
    </aside>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-danger" id="confirm-delete">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    const postId = /*[[${postId}]]*/ 1;
    const currentUser = /*[[${currentUser}]]*/ null;
    let currentPage = /*[[${currentPage}]]*/ 0;
    let pageSize = /*[[${pageSize}]]*/ 10;
    let sortOrder = 'newest';
    let editingCommentId = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function () {
        loadComments();
        loadLatestComments();
        setupEventListeners();
    });

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    function setupEventListeners() {
        // –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        const commentForm = document.getElementById('comment-form');
        if (commentForm) {
            commentForm.addEventListener('submit', handleCommentSubmit);
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
        document.getElementById('confirm-delete').addEventListener('click', confirmDelete);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    async function loadComments(page = 0) {
        try {
            showLoading();

            const response = await fetch(`/api/posts/${postId}/comments?page=${page}&size=${pageSize}`);

            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤');
            }

            const data = await response.json();
            renderComments(data);
            renderPagination(data);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
            updateCommentsCount();

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ' + error.message);
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    function renderComments(data) {
        const container = document.getElementById('comments-container');

        if (!data.comments || data.comments.length === 0) {
            container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
                    </div>
                `;
            return;
        }

        const commentsHtml = data.comments.map(comment => `
                <div class="comment-item" data-comment-id="${comment.id}">
                    <div class="d-flex align-items-start">
                        <img src="${comment.author.imageUrl || '/images/default-avatar.png'}"
                             alt="${comment.author.firstName} ${comment.author.lastName}"
                             class="comment-avatar me-3"
                             onerror="this.src='/images/default-avatar.png'">
                        <div class="flex-grow-1">
                            <div class="comment-content">
                                <div class="d-flex justify-content-between align-items-start">
                                    <strong>${comment.author.firstName} ${comment.author.lastName}</strong>
                                    <small class="text-muted">${formatDate(comment.createdAt)}</small>
                                </div>
                                <div class="comment-text mt-1">${comment.content}</div>
                            </div>

                            ${renderCommentActions(comment)}

                            <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                            <div class="edit-form" id="edit-form-${comment.id}">
                                <div class="mb-2">
                                    <textarea class="form-control" rows="2" id="edit-content-${comment.id}">${comment.content}</textarea>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-success me-2" onclick="saveEdit(${comment.id})">
                                        <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="cancelEdit(${comment.id})">
                                        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

        container.innerHTML = commentsHtml;
    }

    // –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    function renderCommentActions(comment) {
        if (!currentUser) return '';

        const isOwner = currentUser.id === comment.author.id;

        if (!isOwner) return '';

        return `
                <div class="comment-actions mt-2">
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="editComment(${comment.id})">
                        <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id})">
                        <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            `;
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    function renderPagination(data) {
        const pagination = document.getElementById('pagination');
        const pageInfo = data.pageInfo;

        if (!pageInfo.hasNext && !pageInfo.hasPrevious) {
            pagination.innerHTML = '';
            return;
        }

        let paginationHtml = '';

        // –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        if (pageInfo.hasPrevious) {
            paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${pageInfo.currentPage - 1})">
                            <i class="fas fa-chevron-left"></i> –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                        </a>
                    </li>
                `;
        }

        // –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        paginationHtml += `
                <li class="page-item active">
                    <span class="page-link">
                        –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageInfo.currentPage + 1}
                    </span>
                </li>
            `;

        // –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        if (pageInfo.hasNext) {
            paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${pageInfo.currentPage + 1})">
                            –°–ª–µ–¥—É—é—â–∞—è <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                `;
        }

        pagination.innerHTML = paginationHtml;
    }

    // –°–º–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function changePage(page) {
        if (page < 0) return;
        currentPage = page;
        loadComments(page);
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    function sortComments(order) {
        sortOrder = order;
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤ API –∑–∞–ø—Ä–æ—Å
        loadComments(0);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    async function handleCommentSubmit(event) {
        event.preventDefault();

        const content = document.getElementById('comment-content').value.trim();

        if (!content) {
            showError('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
            return;
        }

        try {
            const response = await fetch(`/api/posts/${postId}/comments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({content: content})
            });

            const data = await response.json();

            if (response.ok) {
                showSuccess('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω');
                document.getElementById('comment-content').value = '';
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                updateCommentsCount();
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∂–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                loadLatestComments();
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                currentPage = 0;
                loadComments(0);
            } else {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + error.message);
        }
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    function editComment(commentId) {
        const editForm = document.getElementById(`edit-form-${commentId}`);
        const commentText = editForm.parentElement.querySelector('.comment-text');

        editForm.style.display = 'block';
        commentText.style.display = 'none';
        editingCommentId = commentId;
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    async function saveEdit(commentId) {
        const content = document.getElementById(`edit-content-${commentId}`).value.trim();

        if (!content) {
            showError('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
            return;
        }

        try {
            const response = await fetch(`/api/posts/${postId}/comments/${commentId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({content: content})
            });

            const data = await response.json();

            if (response.ok) {
                showSuccess('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
                loadComments(currentPage);
            } else {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + error.message);
        }
    }

    // –û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function cancelEdit(commentId) {
        const editForm = document.getElementById(`edit-form-${commentId}`);
        const commentText = editForm.parentElement.querySelector('.comment-text');

        editForm.style.display = 'none';
        commentText.style.display = 'block';
        editingCommentId = null;
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    function deleteComment(commentId) {
        editingCommentId = commentId;
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        deleteModal.show();
    }

    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
    async function confirmDelete() {
        if (!editingCommentId) return;

        try {
            const response = await fetch(`/api/posts/${postId}/comments/${editingCommentId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (response.ok) {
                showSuccess('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                updateCommentsCount();
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                loadComments(currentPage);
            } else {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + error.message);
        } finally {
            const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            deleteModal.hide();
            editingCommentId = null;
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    async function updateCommentsCount() {
        try {
            const response = await fetch(`/api/posts/${postId}/comments/count`);
            const data = await response.json();

            if (data.success) {
                document.getElementById('total-comments').textContent = data.count;
                document.getElementById('comments-count').textContent = data.count;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ —Å–∞–π–¥–±–∞—Ä–µ
                const sidebarCount = document.getElementById('sidebar-comments-count');
                if (sidebarCount) {
                    sidebarCount.textContent = data.count;
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á–µ—Ç—á–∏–∫–∞:', error);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞
    async function loadLatestComments() {
        try {
            const response = await fetch(`/api/posts/${postId}/comments/latest?limit=3`);
            const data = await response.json();

            const widget = document.getElementById('latest-comments-widget');

            if (data.success && data.comments && data.comments.length > 0) {
                const commentsHtml = data.comments.map(comment => `
                        <div class="latest-comment">
                            <img src="${comment.author.imageUrl || '/images/default-avatar.png'}"
                                 alt="${comment.author.firstName} ${comment.author.lastName}"
                                 class="latest-comment-avatar"
                                 onerror="this.src='/images/default-avatar.png'">
                            <div class="latest-comment-content">
                                <div class="latest-comment-author">${comment.author.firstName} ${comment.author.lastName}</div>
                                <div class="latest-comment-text">${comment.content}</div>
                                <div class="latest-comment-time">${formatDate(comment.createdAt)}</div>
                            </div>
                        </div>
                    `).join('');

                widget.innerHTML = commentsHtml;
            } else {
                widget.innerHTML = '<div class="text-center text-muted py-3">–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>';
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', error);
            document.getElementById('latest-comments-widget').innerHTML =
                '<div class="text-center text-muted py-3">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π –≤ —Å–∞–π–¥–±–∞—Ä–µ
    function sharePost() {
        if (navigator.share) {
            navigator.share({
                title: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø–æ—Å—Ç—É',
                url: window.location.href
            });
        } else {
            // Fallback - –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
            navigator.clipboard.writeText(window.location.href).then(() => {
                showSuccess('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
            });
        }
    }

    function reportPost() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –∂–∞–ª–æ–±—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            showSuccess('–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ');
        }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function showLoading() {
        document.getElementById('comments-container').innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...
                </div>
            `;
    }

    function showError(message) {
        const notifications = document.getElementById('notifications');
        notifications.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> ${message}</div>`;
        setTimeout(() => notifications.innerHTML = '', 5000);
    }

    function showSuccess(message) {
        const notifications = document.getElementById('notifications');
        notifications.innerHTML = `<div class="success"><i class="fas fa-check-circle"></i> ${message}</div>`;
        setTimeout(() => notifications.innerHTML = '', 3000);
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        if (diffMins < 60) return `${diffMins} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
        if (diffHours < 24) return `${diffHours} —á. –Ω–∞–∑–∞–¥`;
        if (diffDays < 7) return `${diffDays} –¥–Ω. –Ω–∞–∑–∞–¥`;

        return date.toLocaleDateString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
</script>
</body>
</html>