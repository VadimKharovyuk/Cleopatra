<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${otherUser.displayName + ' - –ß–∞—Ç'}">–ß–∞—Ç - Cleopatra</title>
</head>
<body>
<div class="chat-container">
    <header class="chat-header">
        <a href="/messages" class="back-btn">‚Üê –ù–∞–∑–∞–¥</a>

        <div class="chat-user-info">
            <div class="avatar">
                <img th:if="${otherUser.imageUrl}"
                     th:src="${otherUser.imageUrl}"
                     th:alt="${otherUser.displayName}">
                <div th:unless="${otherUser.imageUrl}"
                     class="avatar-placeholder"
                     th:text="${otherUser.initials}">–ê–ê</div>
                <div th:if="${otherUser.isOnline}" class="online-indicator"></div>
            </div>

            <div class="user-details">
                <h3 th:text="${otherUser.displayName}">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                <span class="status" th:text="${otherUser.lastSeenText}">–≤ —Å–µ—Ç–∏</span>
            </div>
        </div>

        <div class="chat-actions">
            <button onclick="searchInChat()" title="–ü–æ–∏—Å–∫">üîç</button>
            <button onclick="showChatInfo()" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">‚ÑπÔ∏è</button>
        </div>
    </header>

    <div th:if="${error}" class="error-message">
        <p th:text="${error}">–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ</p>
    </div>

    <div class="messages-container" id="messagesContainer">
        <div th:if="${!hasMessages}" class="no-messages">
            <p>–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –ù–∞—á–Ω–∏—Ç–µ —Ä–∞–∑–≥–æ–≤–æ—Ä!</p>
        </div>

        <div th:if="${canLoadMore}" class="load-more-messages">
            <button onclick="loadMoreMessages()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è</button>
        </div>

        <div class="messages-list" id="messagesList">
            <div th:each="message : ${conversation.messages}"
                 class="message"
                 th:classappend="${message.isOwnMessage ? 'own' : 'other'}"
                 th:data-message-id="${message.id}">

                <div class="message-content">
                    <div th:if="${message.replyToMessage}" class="reply-to">
                        <div class="reply-line"></div>
                        <div class="reply-content">
                            <span class="reply-author" th:text="${message.replyToMessage.sender.displayName}">–ê–≤—Ç–æ—Ä</span>
                            <span class="reply-text" th:text="${message.replyToMessage.shortContent}">–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞</span>
                        </div>
                    </div>

                    <div class="message-body">
                        <span class="message-text" th:text="${message.content}">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</span>

                        <div class="message-info">
                            <span class="time" th:text="${message.timeAgo}">5 –º–∏–Ω –Ω–∞–∑–∞–¥</span>
                            <span th:if="${message.isEdited}" class="edited">–∏–∑–º–µ–Ω–µ–Ω–æ</span>

                            <div th:if="${message.isOwnMessage}" class="message-status">
                                    <span th:switch="${message.deliveryStatus.name()}">
                                        <span th:case="'SENT'">‚úì</span>
                                        <span th:case="'DELIVERED'">‚úì‚úì</span>
                                        <span th:case="'READ'">‚úì‚úì</span>
                                    </span>
                            </div>
                        </div>
                    </div>

                    <div th:if="${message.canEdit or message.canDelete}" class="message-actions">
                        <button th:if="${message.canEdit}"
                                th:onclick="'editMessage(' + ${message.id} + ')'"
                                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                        <button onclick="replyToMessage([[${message.id}]])" title="–û—Ç–≤–µ—Ç–∏—Ç—å">‚Ü©Ô∏è</button>
                        <button th:if="${message.canDelete}"
                                th:onclick="'deleteMessage(' + ${message.id} + ')'"
                                title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="typing-indicator" id="typingIndicator" style="display: none;">
        <span th:text="${otherUser.displayName}">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span> –ø–µ—á–∞—Ç–∞–µ—Ç...
    </div>

    <div class="message-input-container">
        <div id="replyPreview" class="reply-preview" style="display: none;">
            <div class="reply-content">
                <span class="reply-to-text">–û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ:</span>
                <span id="replyText"></span>
            </div>
            <button onclick="cancelReply()">‚úï</button>
        </div>

        <div class="input-group">
            <input type="text"
                   id="messageInput"
                   placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                   onkeypress="handleKeyPress(event)"
                   oninput="handleTyping()">
            <button id="sendButton" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
    const currentUserId = [[${currentUserId}]];
    const otherUserId = [[${otherUserId}]];
    let currentPage = [[${conversation.currentPage}]];
    let replyToMessageId = null;
    let typingTimer = null;
    let isTyping = false;

    // WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    let socket = null;

    function initWebSocket() {
        const wsUrl = `ws://localhost:8080/chat?userId=${currentUserId}`;
        socket = new WebSocket(wsUrl);

        socket.onopen = function() {
            console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
        };

        socket.onmessage = function(event) {
            const message = JSON.parse(event.data);
            handleWebSocketMessage(message);
        };

        socket.onclose = function() {
            console.log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
            // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(initWebSocket, 5000);
        };
    }

    function handleWebSocketMessage(message) {
        switch(message.action) {
            case 'NEW_MESSAGE':
                if (message.senderId == otherUserId) {
                    addMessageToChat(message, false);
                    markMessagesAsRead();
                }
                break;
            case 'TYPING_START':
                if (message.senderId == otherUserId) {
                    showTypingIndicator(true);
                }
                break;
            case 'TYPING_STOP':
                if (message.senderId == otherUserId) {
                    showTypingIndicator(false);
                }
                break;
            case 'MESSAGE_EDITED':
                updateMessage(message);
                break;
            case 'MESSAGE_DELETED':
                removeMessage(message.id);
                break;
        }
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const content = input.value.trim();

        if (!content) return;

        const messageData = {
            recipientId: otherUserId,
            content: content,
            replyToMessageId: replyToMessageId
        };

        fetch('/messages/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(messageData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addMessageToChat(data.message, true);
                    input.value = '';
                    cancelReply();
                    stopTyping();
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + data.error);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            });
    }

    function addMessageToChat(message, isOwn) {
        const messagesList = document.getElementById('messagesList');
        const messageHtml = createMessageHtml(message, isOwn);
        messagesList.insertAdjacentHTML('beforeend', messageHtml);
        scrollToBottom();
    }

    function createMessageHtml(message, isOwn) {
        return `
                <div class="message ${isOwn ? 'own' : 'other'}" data-message-id="${message.id}">
                    <div class="message-content">
                        ${message.replyToMessage ? `
                            <div class="reply-to">
                                <div class="reply-line"></div>
                                <div class="reply-content">
                                    <span class="reply-author">${message.replyToMessage.sender.displayName}</span>
                                    <span class="reply-text">${message.replyToMessage.shortContent}</span>
                                </div>
                            </div>
                        ` : ''}

                        <div class="message-body">
                            <span class="message-text">${message.content}</span>
                            <div class="message-info">
                                <span class="time">${message.timeAgo}</span>
                                ${message.isEdited ? '<span class="edited">–∏–∑–º–µ–Ω–µ–Ω–æ</span>' : ''}
                                ${isOwn ? `<div class="message-status">${getStatusIcon(message.deliveryStatus)}</div>` : ''}
                            </div>
                        </div>

                        ${(message.canEdit || message.canDelete) ? `
                            <div class="message-actions">
                                ${message.canEdit ? `<button onclick="editMessage(${message.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>` : ''}
                                <button onclick="replyToMessage(${message.id})" title="–û—Ç–≤–µ—Ç–∏—Ç—å">‚Ü©Ô∏è</button>
                                ${message.canDelete ? `<button onclick="deleteMessage(${message.id})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>` : ''}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    function handleTyping() {
        if (!isTyping) {
            isTyping = true;
            sendTypingNotification(true);
        }

        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            stopTyping();
        }, 3000);
    }

    function stopTyping() {
        if (isTyping) {
            isTyping = false;
            sendTypingNotification(false);
        }
    }

    function sendTypingNotification(typing) {
        fetch(`/messages/typing/${otherUserId}?isTyping=${typing}`, {
            method: 'POST'
        });
    }

    function showTypingIndicator(show) {
        const indicator = document.getElementById('typingIndicator');
        indicator.style.display = show ? 'block' : 'none';
        if (show) {
            scrollToBottom();
        }
    }

    function replyToMessage(messageId) {
        // –ù–∞–π—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é –æ—Ç–≤–µ—Ç–∞
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        const messageText = messageElement.querySelector('.message-text').textContent;

        replyToMessageId = messageId;

        const replyPreview = document.getElementById('replyPreview');
        const replyText = document.getElementById('replyText');

        replyText.textContent = messageText.length > 50 ? messageText.substring(0, 50) + '...' : messageText;
        replyPreview.style.display = 'block';

        document.getElementById('messageInput').focus();
    }

    function cancelReply() {
        replyToMessageId = null;
        document.getElementById('replyPreview').style.display = 'none';
    }

    function editMessage(messageId) {
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        const messageText = messageElement.querySelector('.message-text').textContent;

        const newText = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:', messageText);
        if (newText && newText !== messageText) {
            fetch(`/messages/edit/${messageId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ content: newText })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateMessage(data.message);
                    } else {
                        alert('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ' + data.error);
                    }
                });
        }
    }

    function deleteMessage(messageId) {
        if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
            const deleteForEveryone = confirm('–£–¥–∞–ª–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö?');

            fetch(`/messages/delete/${messageId}?deleteForEveryone=${deleteForEveryone}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        removeMessage(messageId);
                    } else {
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + data.error);
                    }
                });
        }
    }

    function updateMessage(message) {
        const messageElement = document.querySelector(`[data-message-id="${message.id}"]`);
        if (messageElement) {
            const textElement = messageElement.querySelector('.message-text');
            textElement.textContent = message.content;

            const infoElement = messageElement.querySelector('.message-info');
            if (!infoElement.querySelector('.edited')) {
                infoElement.insertAdjacentHTML('afterbegin', '<span class="edited">–∏–∑–º–µ–Ω–µ–Ω–æ</span>');
            }
        }
    }

    function removeMessage(messageId) {
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
            messageElement.remove();
        }
    }

    function markMessagesAsRead() {
        fetch(`/messages/mark-read/${otherUserId}`, {
            method: 'POST'
        });
    }

    function scrollToBottom() {
        const container = document.getElementById('messagesContainer');
        container.scrollTop = container.scrollHeight;
    }

    function getStatusIcon(status) {
        switch(status) {
            case 'SENT': return '‚úì';
            case 'DELIVERED': return '‚úì‚úì';
            case 'READ': return '‚úì‚úì';
            default: return '';
        }
    }

    function loadMoreMessages() {
        fetch(`/messages/chat/${otherUserId}/load-more?page=${currentPage + 1}`)
            .then(response => response.json())
            .then(data => {
                // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
                prependMessages(data.messages);
                currentPage++;

                if (!data.hasNext) {
                    document.querySelector('.load-more-messages').style.display = 'none';
                }
            });
    }

    function prependMessages(messages) {
        const messagesList = document.getElementById('messagesList');
        const fragment = document.createDocumentFragment();

        messages.reverse().forEach(message => {
            const div = document.createElement('div');
            div.innerHTML = createMessageHtml(message, message.isOwnMessage);
            fragment.appendChild(div.firstChild);
        });

        messagesList.insertBefore(fragment, messagesList.firstChild);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
        initWebSocket();
        markMessagesAsRead();
        scrollToBottom();
    });
</script>
</body>
</html>