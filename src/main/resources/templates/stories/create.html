<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é - Cleopatra</title>
</head>
<body>
<h1>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é</h1>

<div>
  <a href="/stories">‚Üê –ù–∞–∑–∞–¥ –∫ –∏—Å—Ç–æ—Ä–∏—è–º</a>
</div>

<hr>

<div>
  <p><strong>–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID:</strong> <span th:text="${currentUserId}">1</span></p>
</div>

<hr>

<form id="createStoryForm" enctype="multipart/form-data">
  <input type="hidden" name="currentUserId" th:value="${currentUserId}">

  <div>
    <label for="imageFile"><strong>–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</strong></label><br>
    <input type="file" id="imageFile" name="file" accept="image/*" required>
    <br><small>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPG, PNG, GIF. –ú–∞–∫—Å–∏–º—É–º: 10MB</small>
  </div>

  <br>

  <!-- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä -->
  <div id="imagePreview" style="display: none;">
    <h3>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä:</h3>
    <img id="previewImg" alt="–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä" style="max-width: 300px; max-height: 300px;">
  </div>

  <br>

  <div>
    <label for="emoji"><strong>–≠–º–æ–¥–∑–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</strong></label><br>
    <select id="emoji" name="emoji">
      <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏ --</option>
      <option th:each="emoji : ${storyEmojiValues}"
              th:value="${emoji.name()}"
              th:text="${emoji.emoji + ' ' + emoji.description}">
        ‚ù§Ô∏è –°–µ—Ä–¥—Ü–µ
      </option>
    </select>
  </div>

  <br>

  <div>
    <label for="description"><strong>–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</strong></label><br>
    <textarea id="description" name="description" rows="3" cols="50" maxlength="500"
              placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –æ —Å–≤–æ–µ–π –∏—Å—Ç–æ—Ä–∏–∏..."></textarea>
    <br><small><span id="charCount">0</span>/500 —Å–∏–º–≤–æ–ª–æ–≤</small>
  </div>

  <br>

  <div style="border: 1px solid #ccc; padding: 10px;">
    <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏:</h3>
    <p>–í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ <strong>24 —á–∞—Å–æ–≤</strong> —Å –º–æ–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è.</p>
    <p>–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç—Å—è.</p>
  </div>

  <br>

  <div>
    <button type="submit" id="createBtn">–°–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    <a href="/stories">–û—Ç–º–µ–Ω–∞</a>
  </div>
</form>

<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="loadingIndicator" style="display: none;">
  <hr>
  <h3>–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞—à—É –∏—Å—Ç–æ—Ä–∏—é...</h3>
  <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ. –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>
</div>

<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
<div id="result" style="display: none;">
  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∑–¥–µ—Å—å -->
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('createStoryForm');
    const fileInput = document.getElementById('imageFile');
    const previewContainer = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const description = document.getElementById('description');
    const charCount = document.getElementById('charCount');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const result = document.getElementById('result');

    // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (10MB)
        if (file.size > 10 * 1024 * 1024) {
          alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10MB');
          fileInput.value = '';
          previewContainer.style.display = 'none';
          return;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
        if (!file.type.startsWith('image/')) {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!');
          fileInput.value = '';
          previewContainer.style.display = 'none';
          return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImg.src = e.target.result;
          previewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    // –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏
    description.addEventListener('input', function() {
      const length = this.value.length;
      charCount.textContent = length;
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ —Ñ–∞–π–ª
      if (!fileInput.files[0]) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!');
        return;
      }

      console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É...');

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
      form.style.display = 'none';
      loadingIndicator.style.display = 'block';

      // –°–æ–∑–¥–∞–µ–º FormData
      const formData = new FormData(form);

      // –í—ã–≤–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      console.log('FormData —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:');
      for (let pair of formData.entries()) {
        console.log(pair[0] + ': ' + pair[1]);
      }

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
      fetch('/stories/api/create', {
        method: 'POST',
        body: formData
      })
              .then(response => {
                console.log('–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω:', response.status);
                if (response.ok) {
                  return response.json();
                } else {
                  return response.text().then(text => {
                    throw new Error(text);
                  });
                }
              })
              .then(data => {
                console.log('–£—Å–ø–µ—à–Ω–æ:', data);
                // –£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ
                loadingIndicator.style.display = 'none';
                result.innerHTML = `
                        <hr>
                        <h3>‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!</h3>
                        <p>ID –∏—Å—Ç–æ—Ä–∏–∏: ${data.id}</p>
                        <p>–í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.</p>
                        <div>
                            <a href="/stories/${data.id}">üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é</a> |
                            <a href="/stories">üì± –ö —Å–ø–∏—Å–∫—É –∏—Å—Ç–æ—Ä–∏–π</a> |
                            <a href="/stories/create">‚ûï –°–æ–∑–¥–∞—Ç—å –µ—â–µ –æ–¥–Ω—É</a>
                        </div>
                    `;
                result.style.display = 'block';
              })
              .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                // –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è
                loadingIndicator.style.display = 'none';
                result.innerHTML = `
                        <hr>
                        <h3>‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏</h3>
                        <p>${error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>
                        <div>
                            <button type="button" onclick="tryAgain()">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â–µ —Ä–∞–∑</button>
                            <a href="/stories">‚Üê –ù–∞–∑–∞–¥ –∫ –∏—Å—Ç–æ—Ä–∏—è–º</a>
                        </div>
                    `;
                result.style.display = 'block';
              });
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
    window.tryAgain = function() {
      form.style.display = 'block';
      result.style.display = 'none';
      loadingIndicator.style.display = 'none';

      // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
      fileInput.value = '';
      previewContainer.style.display = 'none';
      description.value = '';
      charCount.textContent = '0';
      document.getElementById('emoji').selectedIndex = 0;
    };
  });
</script>
</body>
</html>