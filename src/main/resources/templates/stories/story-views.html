<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –∏—Å—Ç–æ—Ä–∏–∏</title>
</head>
<body>
<header>
  <h1>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –∏—Å—Ç–æ—Ä–∏–∏ #<span th:text="${storyId}"></span></h1>
  <div th:if="${story}" style="margin: 10px 0; padding: 15px; background-color: #f8f9fa; border-radius: 4px;">
    <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏—Å—Ç–æ—Ä–∏–∏</h3>
    <p><strong>–ê–≤—Ç–æ—Ä:</strong> <span th:text="${story.userFullName}"></span></p>
    <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> <span th:text="${story.description ?: '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}"></span></p>
    <p><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> <span th:text="${story.timeAgo}"></span></p>
    <p><strong>–°—Ç–∞—Ç—É—Å:</strong>
      <span th:if="${story.isExpired}" style="color: red;">–ò—Å—Ç–µ–∫–ª–∞</span>
      <span th:unless="${story.isExpired}" style="color: green;">–ê–∫—Ç–∏–≤–Ω–∞</span>
    </p>
  </div>
  <nav>
    <a href="/stories/list">‚Üê –ù–∞–∑–∞–¥ –∫ –∏—Å—Ç–æ—Ä–∏—è–º</a>
    <a th:href="@{'/stories/user/' + ${story.userId}}">‚Üê –ö –∏—Å—Ç–æ—Ä–∏—è–º –∞–≤—Ç–æ—Ä–∞</a>
  </nav>
</header>

<main>
  <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏–ª–∏ —É—Å–ø–µ—Ö–µ -->
  <div th:if="${message}" style="background-color: #d4edda; border: 1px solid #c3e6cb; padding: 10px; margin: 10px 0; border-radius: 4px;">
    <span th:text="${message}"></span>
  </div>

  <div th:if="${error}" style="background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; margin: 10px 0; border-radius: 4px;">
    <span th:text="${error}"></span>
  </div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ -->
  <section>
    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
    <p><strong>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤:</strong> <span th:text="${totalViews}"></span></p>
    <p><strong>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤:</strong> <span th:text="${#lists.size(views)}"></span></p>
  </section>

  <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏/—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) -->
  <section th:if="${#authentication.name == 'admin@example.com'}" style="border: 2px dashed #ddd; padding: 15px; margin: 20px 0;">
    <h3>üß™ –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</h3>
    <p><em>–≠—Ç–∞ —Å–µ–∫—Ü–∏—è –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</em></p>
    <form th:action="@{/stories/{storyId}/view(storyId=${storyId})}" method="post">
      <button type="submit">–û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä (—Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)</button>
    </form>
  </section>

  <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ -->
  <section>
    <h3>–ö—Ç–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–ª</h3>

    <div th:if="${!hasViews}">
      <p><em>–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–ª —ç—Ç—É –∏—Å—Ç–æ—Ä–∏—é</em></p>
    </div>

    <div th:if="${hasViews}">
      <table border="1" cellpadding="8" cellspacing="0" style="width: 100%; border-collapse: collapse;">
        <thead>
        <tr style="background-color: #f8f9fa;">
          <th>ID –ü—Ä–æ—Å–º–æ—Ç—Ä–∞</th>
          <th>ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</th>
          <th>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</th>
          <th>–í—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="view : ${views}">
          <td th:text="${view.id}"></td>
          <td th:text="${view.viewerId}"></td>
          <td th:text="${view.getId()}"></td>
          <td th:text="${#temporals.format(view.viewedAt, 'dd.MM.yyyy HH:mm:ss')}"></td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤) -->
  <section th:if="${#authentication.name == 'admin@example.com'}" style="border: 2px dashed #ddd; padding: 15px;">
    <h3>üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</h3>
    <p><em>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</em></p>
    <button onclick="checkCurrentUserView()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–π —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</button>
    <div id="checkResult" style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; display: none;"></div>
  </section>

  <!-- –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ -->
  <section>
    <h3>–ê–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</h3>
    <p>–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: <span id="liveCount">–∑–∞–≥—Ä—É–∑–∫–∞...</span></p>
    <button onclick="updateCount()">–û–±–Ω–æ–≤–∏—Ç—å</button>
    <button id="autoRefreshBtn" onclick="toggleAutoRefresh()">–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
  </section>
</main>

<script>
  let autoRefreshInterval;
  let autoRefreshActive = false;

  // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
  function updateCount() {
    const storyId = /*[[${storyId}]]*/ 1;
    fetch(`/stories/${storyId}/views/count`)
            .then(response => response.text())
            .then(count => {
              document.getElementById('liveCount').textContent = count;
            })
            .catch(error => {
              console.error('–û—à–∏–±–∫–∞:', error);
              document.getElementById('liveCount').textContent = '–æ—à–∏–±–∫–∞';
            });
  }

  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–ª –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å—Ç–æ—Ä–∏—é
  function checkCurrentUserView() {
    const storyId = /*[[${storyId}]]*/ 1;
    const resultDiv = document.getElementById('checkResult');

    fetch(`/stories/${storyId}/check-view`)
            .then(response => response.text())
            .then(result => {
              resultDiv.style.display = 'block';
              if (result === 'viewed') {
                resultDiv.style.backgroundColor = '#d4edda';
                resultDiv.style.borderColor = '#c3e6cb';
                resultDiv.textContent = '–í—ã –£–ñ–ï –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–ª–∏ —ç—Ç—É –∏—Å—Ç–æ—Ä–∏—é';
              } else if (result === 'not-viewed') {
                resultDiv.style.backgroundColor = '#fff3cd';
                resultDiv.style.borderColor = '#ffeeba';
                resultDiv.textContent = '–í—ã –ù–ï –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–ª–∏ —ç—Ç—É –∏—Å—Ç–æ—Ä–∏—é';
              } else {
                resultDiv.style.backgroundColor = '#f8d7da';
                resultDiv.style.borderColor = '#f5c6cb';
                resultDiv.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ';
              }
            })
            .catch(error => {
              console.error('–û—à–∏–±–∫–∞:', error);
              resultDiv.style.display = 'block';
              resultDiv.style.backgroundColor = '#f8d7da';
              resultDiv.style.borderColor = '#f5c6cb';
              resultDiv.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ';
            });
  }

  // –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  function toggleAutoRefresh() {
    const btn = document.getElementById('autoRefreshBtn');
    if (autoRefreshActive) {
      clearInterval(autoRefreshInterval);
      autoRefreshActive = false;
      btn.textContent = '–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ';
    } else {
      autoRefreshInterval = setInterval(updateCount, 5000); // –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
      autoRefreshActive = true;
      btn.textContent = '–í—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ';
    }
  }

  // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.onload = function() {
    updateCount();
  };
</script>
</body>
</html>