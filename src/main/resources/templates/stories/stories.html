<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ò—Å—Ç–æ—Ä–∏–∏ - Cleopatra</title>
</head>
<body>
<div class="container">
  <header>
    <h1>üì∏ –ò—Å—Ç–æ—Ä–∏–∏</h1>
    <nav>
      <a href="/stories">–í—Å–µ –∏—Å—Ç–æ—Ä–∏–∏</a>
      <a href="/stories/create">‚ûï –°–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é</a>
      <a th:href="@{'/stories/user/' + ${currentUserId}}">–ú–æ–∏ –∏—Å—Ç–æ—Ä–∏–∏</a>
    </nav>
  </header>

  <main>
    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
    <div th:if="${error}" class="error">
      <p th:text="${error}"></p>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—Ä–∏–π -->
    <div th:if="${storyList}" class="stories-container">
      <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏</h2>

      <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ -->
      <div class="pagination-info">
        <p>
          –°—Ç—Ä–∞–Ω–∏—Ü–∞ <span th:text="${storyList.currentPage + 1}">1</span>
          –∏–∑ <span th:text="${storyList.totalPages}">1</span>
          (–≤—Å–µ–≥–æ –∏—Å—Ç–æ—Ä–∏–π: <span th:text="${storyList.totalElements}">0</span>)
        </p>
      </div>

      <!-- –ò—Å—Ç–æ—Ä–∏–∏ -->
      <div class="stories-grid">
        <div th:each="story : ${storyList.stories}" class="story-card">
          <div class="story-header">
            <div class="user-info">
              <img th:if="${story.userImageUrl}"
                   th:src="${story.userImageUrl}"
                   th:alt="${story.userFullName}"
                   class="user-avatar">
              <div th:unless="${story.userImageUrl}" class="user-avatar-placeholder">üë§</div>
              <div class="user-details">
                <h3 th:text="${story.userFullName}">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                <p class="time-info" th:text="${story.timeAgo}">2 —á–∞—Å–∞ –Ω–∞–∑–∞–¥</p>
              </div>
            </div>

            <!-- –°—Ç–∞—Ç—É—Å -->
            <div class="story-status">
              <span th:if="${story.isOwner}" class="owner-badge">–í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è</span>
              <span th:if="${story.isViewedByCurrentUser}" class="viewed-badge">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</span>
              <span th:if="${story.isExpiringSoon}" class="expiring-badge">‚è∞ –°–∫–æ—Ä–æ –∏—Å—Ç–µ—á–µ—Ç</span>
            </div>
          </div>

          <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ -->
          <div class="story-image">
            <a th:href="@{'/stories/' + ${story.id}}">
              <img th:src="@{'/stories/image/' + ${story.imageId}}"
                   alt="–ò—Å—Ç–æ—Ä–∏—è"
                   class="story-img">
            </a>
          </div>

          <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏ -->
          <div class="story-content">
            <div th:if="${story.emoji}" class="story-emoji">
              <span th:text="${story.emoji.emoji}">‚ù§Ô∏è</span>
              <span th:text="${story.emoji.description}" class="emoji-description">–°–µ—Ä–¥—Ü–µ</span>
            </div>

            <p th:if="${story.description}"
               th:text="${story.description}"
               class="story-description">–û–ø–∏—Å–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏</p>
          </div>

          <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
          <div class="story-stats">
            <div class="views-count">
              üëÅÔ∏è <span th:text="${story.viewsCount}">0</span> –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
            </div>
            <div class="expires-info">
              <span th:text="${story.expiresIn}">–∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 5 —á–∞—Å–æ–≤</span>
            </div>
          </div>

          <!-- –î–µ–π—Å—Ç–≤–∏—è -->
          <div class="story-actions">
            <a th:href="@{'/stories/' + ${story.id}}" class="btn btn-primary">
              üìñ –°–º–æ—Ç—Ä–µ—Ç—å
            </a>

            <div th:if="${story.isOwner}" class="owner-actions">
              <button type="button"
                      class="btn btn-secondary edit-emoji-btn"
                      th:data-story-id="${story.id}">
                üòä –ò–∑–º–µ–Ω–∏—Ç—å —ç–º–æ–¥–∑–∏
              </button>

              <button type="button"
                      class="btn btn-danger delete-story-btn"
                      th:data-story-id="${story.id}">
                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–π -->
      <div th:if="${storyList.isEmpty}" class="no-stories">
        <h3>üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–π</h3>
        <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∏—Å—Ç–æ—Ä–∏—é –∏–ª–∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ, –ø–æ–∫–∞ –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–±–∞–≤—è—Ç —Å–≤–æ–∏!</p>
        <a href="/stories/create" class="btn btn-primary">‚ûï –°–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é</a>
      </div>

      <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
      <div th:if="${!storyList.isEmpty}" class="pagination">
        <a th:if="${storyList.hasPrevious}"
           th:href="@{'/stories'(page=${storyList.previousPage})}"
           class="btn btn-secondary">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>

        <span class="current-page">
                        –°—Ç—Ä–∞–Ω–∏—Ü–∞ <span th:text="${storyList.currentPage + 1}">1</span>
                    </span>

        <a th:if="${storyList.hasNext}"
           th:href="@{'/stories'(page=${storyList.nextPage})}"
           class="btn btn-secondary">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</a>
      </div>
    </div>
  </main>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —ç–º–æ–¥–∑–∏ -->
  <div id="emojiModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏</h3>
      <div class="emoji-grid">
        <button th:each="emoji : ${storyEmojiValues}"
                type="button"
                class="emoji-option"
                th:data-emoji="${emoji.name()}"
                th:title="${emoji.description}">
          <span th:text="${emoji.emoji}">‚ù§Ô∏è</span>
          <span th:text="${emoji.description}">–°–µ—Ä–¥—Ü–µ</span>
        </button>
      </div>
      <div class="modal-actions">
        <button type="button" id="cancelEmojiBtn" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>
</div>

<script>
  // JavaScript –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏ –∏ AJAX
  document.addEventListener('DOMContentLoaded', function() {
    const emojiModal = document.getElementById('emojiModal');
    let currentStoryId = null;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —ç–º–æ–¥–∑–∏
    document.querySelectorAll('.edit-emoji-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        currentStoryId = this.dataset.storyId;
        emojiModal.style.display = 'block';
      });
    });

    // –í—ã–±–æ—Ä —ç–º–æ–¥–∑–∏
    document.querySelectorAll('.emoji-option').forEach(btn => {
      btn.addEventListener('click', function() {
        const emoji = this.dataset.emoji;
        updateStoryEmoji(currentStoryId, emoji);
      });
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('cancelEmojiBtn').addEventListener('click', function() {
      emojiModal.style.display = 'none';
      currentStoryId = null;
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
    document.querySelectorAll('.delete-story-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const storyId = this.dataset.storyId;
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∏—Å—Ç–æ—Ä–∏—é?')) {
          deleteStory(storyId);
        }
      });
    });

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç–º–æ–¥–∑–∏
    function updateStoryEmoji(storyId, emoji) {
      fetch(`/stories/api/${storyId}/emoji`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `emoji=${emoji}&currentUserId=[[${currentUserId}]]`
      })
              .then(response => response.json())
              .then(data => {
                emojiModal.style.display = 'none';
                location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
              })
              .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç–º–æ–¥–∑–∏');
              });
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
    function deleteStory(storyId) {
      fetch(`/stories/api/${storyId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `currentUserId=[[${currentUserId}]]`
      })
              .then(response => {
                if (response.ok) {
                  location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                } else {
                  alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏');
                }
              })
              .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏');
              });
    }
  });
</script>
</body>
</html>