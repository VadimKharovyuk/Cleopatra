<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="'–ò—Å—Ç–æ—Ä–∏—è –æ—Ç ' + ${story.userFullName} + ' - Cleopatra'">–ò—Å—Ç–æ—Ä–∏—è - Cleopatra</title>
</head>
<body>
<div class="container">
  <header>
    <h1>üìñ –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏</h1>
    <nav>
      <a href="/stories">‚Üê –ù–∞–∑–∞–¥ –∫ –∏—Å—Ç–æ—Ä–∏—è–º</a>
      <a th:href="@{'/stories/user/' + ${story.userId}}">–ò—Å—Ç–æ—Ä–∏–∏ –∞–≤—Ç–æ—Ä–∞</a>
      <a th:if="${story.isOwner}" href="/stories/create">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é</a>
    </nav>
  </header>

  <main>
    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
    <div th:if="${error}" class="error">
      <p th:text="${error}"></p>
      <a href="/stories" class="btn btn-primary">‚Üê –ù–∞–∑–∞–¥ –∫ –∏—Å—Ç–æ—Ä–∏—è–º</a>
    </div>

    <!-- –î–µ—Ç–∞–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ -->
    <div th:if="${story}" class="story-detail">

      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏ -->
      <div class="story-header">
        <div class="user-info">
          <img th:if="${story.userImageUrl}"
               th:src="${story.userImageUrl}"
               th:alt="${story.userFullName}"
               class="user-avatar large">
          <div th:unless="${story.userImageUrl}" class="user-avatar-placeholder large">üë§</div>

          <div class="user-details">
            <h2 th:text="${story.userFullName}">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <div class="time-info">
              <span th:text="${story.timeAgo}">2 —á–∞—Å–∞ –Ω–∞–∑–∞–¥</span>
              <span class="separator">‚Ä¢</span>
              <span th:text="${story.expiresIn}">–∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 5 —á–∞—Å–æ–≤</span>
            </div>
          </div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="story-actions">
          <div class="status-badges">
            <span th:if="${story.isOwner}" class="badge owner">–í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è</span>
            <span th:if="${story.isExpiringSoon}" class="badge warning">‚è∞ –°–∫–æ—Ä–æ –∏—Å—Ç–µ—á–µ—Ç</span>
          </div>

          <div th:if="${story.isOwner}" class="owner-controls">
            <button type="button"
                    class="btn btn-secondary"
                    onclick="showEmojiModal()">
              üòä –ò–∑–º–µ–Ω–∏—Ç—å —ç–º–æ–¥–∑–∏
            </button>
            <button type="button"
                    class="btn btn-danger"
                    onclick="deleteStory()">
              üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
            </button>
          </div>
        </div>
      </div>

      <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
      <div class="story-main-image">
        <img th:src="@{'/stories/image/' + ${story.imageId}}"
             th:alt="'–ò—Å—Ç–æ—Ä–∏—è –æ—Ç ' + ${story.userFullName}"
             class="main-story-img">
      </div>

      <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏ -->
      <div class="story-content">
        <div th:if="${story.emoji}" class="story-emoji-display">
          <span class="emoji-large" th:text="${story.emoji.emoji}">‚ù§Ô∏è</span>
          <span class="emoji-name" th:text="${story.emoji.description}">–°–µ—Ä–¥—Ü–µ</span>
        </div>

        <div th:if="${story.description}" class="story-description">
          <h3>üí¨ –û–ø–∏—Å–∞–Ω–∏–µ</h3>
          <p th:text="${story.description}">–û–ø–∏—Å–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏</p>
        </div>
      </div>

      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ -->
      <div class="story-stats">
        <h3>üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä—ã (<span th:text="${story.viewsCount}">0</span>)</h3>

        <div th:if="${views != null and !views.isEmpty()}" class="views-list">
          <div th:each="view : ${views}" class="view-item">
            <img th:if="${view.viewerImageUrl}"
                 th:src="${view.viewerImageUrl}"
                 th:alt="${view.viewerFullName}"
                 class="viewer-avatar">
            <div th:unless="${view.viewerImageUrl}" class="viewer-avatar-placeholder">üë§</div>

            <div class="viewer-info">
              <span class="viewer-name" th:text="${view.viewerFullName}">–ò–º—è –∑—Ä–∏—Ç–µ–ª—è</span>
              <span class="view-time" th:text="${view.timeAgo}">—á–∞—Å –Ω–∞–∑–∞–¥</span>
            </div>
          </div>
        </div>

        <div th:if="${views == null or views.isEmpty()}" class="no-views">
          <p>üëª –ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –ø–æ—Å–º–æ—Ç—Ä–µ–ª —ç—Ç—É –∏—Å—Ç–æ—Ä–∏—é</p>
          <p th:unless="${story.isOwner}">–í—ã –ø–µ—Ä–≤—ã–π –∑—Ä–∏—Ç–µ–ª—å!</p>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ -->
        <div class="views-actions">
          <button type="button"
                  class="btn btn-outline"
                  onclick="refreshViews()">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä—ã
          </button>
        </div>
      </div>

      <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∏—Å—Ç–æ—Ä–∏—è–º -->
      <div class="story-navigation">
        <h3>üîÑ –î—Ä—É–≥–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
        <div class="nav-actions">
          <a th:href="@{'/stories/user/' + ${story.userId}}" class="btn btn-secondary">
            üì± –í—Å–µ –∏—Å—Ç–æ—Ä–∏–∏ –∞–≤—Ç–æ—Ä–∞
          </a>
          <a href="/stories" class="btn btn-secondary">
            üåü –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä—É–≥–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
          </a>
          <a th:unless="${story.isOwner}" href="/stories/create" class="btn btn-primary">
            ‚ûï –°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é –∏—Å—Ç–æ—Ä–∏—é
          </a>
        </div>
      </div>
    </div>
  </main>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —ç–º–æ–¥–∑–∏ -->
  <div id="emojiModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>üòä –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤–æ–µ —ç–º–æ–¥–∑–∏</h3>
      <div class="emoji-grid">
        <button th:each="emoji : ${storyEmojiValues}"
                type="button"
                class="emoji-option"
                th:data-emoji="${emoji.name()}"
                th:title="${emoji.description}">
          <span th:text="${emoji.emoji}">‚ù§Ô∏è</span>
          <span th:text="${emoji.description}">–°–µ—Ä–¥—Ü–µ</span>
        </button>
        <button type="button"
                class="emoji-option remove-emoji"
                data-emoji=""
                title="–£–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏">
          ‚ùå –£–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏
        </button>
      </div>
      <div class="modal-actions">
        <button type="button" onclick="hideEmojiModal()" class="btn btn-secondary">
          –û—Ç–º–µ–Ω–∞
        </button>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
  const storyId = /*[[${story.id}]]*/ 1;
  const currentUserId = /*[[${currentUserId}]]*/ 1;

  // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —ç–º–æ–¥–∑–∏
  function showEmojiModal() {
    document.getElementById('emojiModal').style.display = 'block';
  }

  // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —ç–º–æ–¥–∑–∏
  function hideEmojiModal() {
    document.getElementById('emojiModal').style.display = 'none';
  }

  // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä—ã
  function refreshViews() {
    fetch(`/stories/api/${storyId}/views`)
            .then(response => response.json())
            .then(views => {
              location.reload(); // –ü—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            })
            .catch(error => {
              console.error('Error refreshing views:', error);
              alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤');
            });
  }

  // –£–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
  function deleteStory() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∏—Å—Ç–æ—Ä–∏—é? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) {
      fetch(`/stories/api/${storyId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `currentUserId=${currentUserId}`
      })
              .then(response => {
                if (response.ok) {
                  alert('–ò—Å—Ç–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                  window.location.href = '/stories';
                } else {
                  return response.text().then(text => {
                    throw new Error(text);
                  });
                }
              })
              .catch(error => {
                console.error('Error deleting story:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏: ' + error.message);
              });
    }
  }

  // –û–±–Ω–æ–≤–∏—Ç—å —ç–º–æ–¥–∑–∏
  function updateEmoji(emoji) {
    const body = emoji ? `emoji=${emoji}&currentUserId=${currentUserId}` : `currentUserId=${currentUserId}`;

    fetch(`/stories/api/${storyId}/emoji`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: body
    })
            .then(response => {
              if (response.ok) {
                hideEmojiModal();
                location.reload();
              } else {
                return response.text().then(text => {
                  throw new Error(text);
                });
              }
            })
            .catch(error => {
              console.error('Error updating emoji:', error);
              alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç–º–æ–¥–∑–∏: ' + error.message);
            });
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
  document.addEventListener('DOMContentLoaded', function() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —ç–º–æ–¥–∑–∏
    document.querySelectorAll('.emoji-option').forEach(btn => {
      btn.addEventListener('click', function() {
        const emoji = this.dataset.emoji;
        updateEmoji(emoji);
      });
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
    document.getElementById('emojiModal').addEventListener('click', function(e) {
      if (e.target === this) {
        hideEmojiModal();
      }
    });
  });
</script>
</body>
</html>