<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${pageTitle}">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã - Cleopatra</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(45deg, #27ae60, #219a52);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .nav-links {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
      text-align: center;
    }

    .nav-links a {
      color: white;
      text-decoration: none;
      padding: 8px 16px;
      margin: 0 5px;
      border-radius: 5px;
      background: rgba(255,255,255,0.2);
      transition: background 0.3s;
    }

    .nav-links a:hover {
      background: rgba(255,255,255,0.3);
    }

    .content {
      padding: 30px;
    }

    .monitor-section {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 25px;
      border-left: 5px solid #27ae60;
    }

    .monitor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .monitor-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-left: 4px solid #27ae60;
      position: relative;
      overflow: hidden;
    }

    .monitor-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 50px;
      height: 50px;
      background: linear-gradient(45deg, rgba(39,174,96,0.1), rgba(39,174,96,0.05));
      border-radius: 0 10px 0 50px;
    }

    .monitor-card h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #ecf0f1;
    }

    .metric:last-child {
      border-bottom: none;
    }

    .metric-label {
      color: #7f8c8d;
      font-weight: 500;
    }

    .metric-value {
      color: #2c3e50;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .metric-value.normal {
      color: #27ae60;
    }

    .metric-value.warning {
      color: #f39c12;
    }

    .metric-value.critical {
      color: #e74c3c;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ecf0f1;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #27ae60, #2ecc71);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .progress-fill.warning {
      background: linear-gradient(90deg, #f39c12, #e67e22);
    }

    .progress-fill.critical {
      background: linear-gradient(90deg, #e74c3c, #c0392b);
    }

    .btn {
      background: linear-gradient(45deg, #27ae60, #219a52);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
    }

    .btn-primary {
      background: linear-gradient(45deg, #3498db, #2980b9);
    }

    .btn-warning {
      background: linear-gradient(45deg, #f39c12, #e67e22);
    }

    .btn-danger {
      background: linear-gradient(45deg, #e74c3c, #c0392b);
    }

    .controls {
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-normal {
      background: #27ae60;
    }

    .status-warning {
      background: #f39c12;
      animation: pulse 2s infinite;
    }

    .status-critical {
      background: #e74c3c;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .real-time-log {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 20px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }

    .log-entry {
      margin-bottom: 5px;
      padding: 2px 0;
    }

    .log-entry.info {
      color: #3498db;
    }

    .log-entry.warning {
      color: #f39c12;
    }

    .log-entry.error {
      color: #e74c3c;
    }

    .log-entry.success {
      color: #27ae60;
    }

    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .chart-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .chart-card h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      text-align: center;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #27ae60;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üíª –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã</h1>
    <p>–†–µ–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ä–µ—Å—É—Ä—Å–æ–≤ —Å–∏—Å—Ç–µ–º—ã</p>

    <div class="nav-links">
      <a href="/diagnostic/load-test">üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</a>
      <a href="/diagnostic/load-test/results">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</a>
      <a href="/diagnostic/system-monitor">üíª –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</a>
      <a href="/diagnostic/memory">üß† –ü–∞–º—è—Ç—å</a>
    </div>
  </div>

  <div class="content">
    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º -->
    <div class="controls">
      <h3>üéõÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º</h3>
      <button class="btn" onclick="startMonitoring()">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
      <button class="btn btn-warning" onclick="stopMonitoring()">‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
      <button class="btn btn-primary" onclick="refreshData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
      <button class="btn btn-danger" onclick="clearLogs()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
      <div style="margin-top: 15px;">
        <label for="refreshInterval">–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</label>
        <select id="refreshInterval" onchange="updateRefreshInterval()">
          <option value="1000">1 —Å–µ–∫—É–Ω–¥–∞</option>
          <option value="3000">3 —Å–µ–∫—É–Ω–¥—ã</option>
          <option value="5000" selected>5 —Å–µ–∫—É–Ω–¥</option>
          <option value="10000">10 —Å–µ–∫—É–Ω–¥</option>
          <option value="30000">30 —Å–µ–∫—É–Ω–¥</option>
        </select>
      </div>
    </div>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞...</p>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã -->
    <div class="monitor-section">
      <h2>üìä –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
      <div class="monitor-grid">
        <!-- –ü–∞–º—è—Ç—å JVM -->
        <div class="monitor-card">
          <h3>üß† –ü–∞–º—è—Ç—å JVM</h3>
          <div class="metric">
            <span class="metric-label">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:</span>
            <span class="metric-value" id="memoryUsed">-- –ú–ë</span>
          </div>
          <div class="metric">
            <span class="metric-label">–í—ã–¥–µ–ª–µ–Ω–æ:</span>
            <span class="metric-value" id="memoryAllocated">-- –ú–ë</span>
          </div>
          <div class="metric">
            <span class="metric-label">–ú–∞–∫—Å–∏–º—É–º:</span>
            <span class="metric-value" id="memoryMax">-- –ú–ë</span>
          </div>
          <div class="metric">
            <span class="metric-label">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:</span>
            <span class="metric-value" id="memoryPercent">--%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="memoryProgress" style="width: 0%"></div>
          </div>
        </div>

        <!-- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö -->
        <div class="monitor-card">
          <h3>üóÑÔ∏è –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ë–î</h3>
          <div class="metric">
            <span class="metric-label">–ê–∫—Ç–∏–≤–Ω—ã–µ:</span>
            <span class="metric-value" id="dbActive">--</span>
          </div>
          <div class="metric">
            <span class="metric-label">–û–∂–∏–¥–∞—é—â–∏–µ:</span>
            <span class="metric-value" id="dbIdle">--</span>
          </div>
          <div class="metric">
            <span class="metric-label">–í—Å–µ–≥–æ:</span>
            <span class="metric-value" id="dbTotal">--</span>
          </div>
          <div class="metric">
            <span class="metric-label">–û–∂–∏–¥–∞—é—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</span>
            <span class="metric-value" id="dbWaiting">--</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="dbProgress" style="width: 0%"></div>
          </div>
        </div>

        <!-- –°–∏—Å—Ç–µ–º–∞ -->
        <div class="monitor-card">
          <h3>‚öôÔ∏è –°–∏—Å—Ç–µ–º–∞</h3>
          <div class="metric">
            <span class="metric-label">–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã:</span>
            <span class="metric-value" id="processors">--</span>
          </div>
          <div class="metric">
            <span class="metric-label">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</span>
            <span class="metric-value" id="uptime">-- –º–∏–Ω</span>
          </div>
          <div class="metric">
            <span class="metric-label">–¶–∏–∫–ª—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:</span>
            <span class="metric-value" id="monitoringCycles">--</span>
          </div>
          <div class="metric">
            <span class="metric-label">–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã:</span>
            <span class="metric-value" id="systemStatus">
                                <span class="status-indicator status-normal"></span>–ó–∞–≥—Ä—É–∑–∫–∞...
                            </span>
          </div>
        </div>

        <!-- Heap –ø–∞–º—è—Ç—å -->
        <div class="monitor-card">
          <h3>üì¶ –î–µ—Ç–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å</h3>
          <div class="metric">
            <span class="metric-label">Heap –ø–∞–º—è—Ç—å:</span>
            <span class="metric-value" id="heapMemory">-- –ú–ë</span>
          </div>
          <div class="metric">
            <span class="metric-label">Non-Heap –ø–∞–º—è—Ç—å:</span>
            <span class="metric-value" id="nonHeapMemory">-- –ú–ë</span>
          </div>
          <div class="metric">
            <span class="metric-label">–°–≤–æ–±–æ–¥–Ω–∞—è –ø–∞–º—è—Ç—å:</span>
            <span class="metric-value" id="freeMemory">-- –ú–ë</span>
          </div>
          <div class="metric">
            <span class="metric-label">–°—Ç–∞—Ç—É—Å –ø–∞–º—è—Ç–∏:</span>
            <span class="metric-value" id="memoryStatus">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- –ê–ª–µ—Ä—Ç—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="monitor-section">
      <h2>üö® –ê–ª–µ—Ä—Ç—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
      <div id="alertsContainer">
        <div style="text-align: center; padding: 20px; color: #7f8c8d;">
          –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–ª–µ—Ä—Ç–æ–≤ –∞–∫—Ç–∏–≤–µ–Ω. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –∑–¥–µ—Å—å.
        </div>
      </div>
    </div>

    <!-- –†–µ–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ -->
    <div class="monitor-section">
      <h2>üìù –†–µ–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
      <div class="real-time-log" id="systemLogs">
        <div class="log-entry info">[–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø] –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–∞–ø—É—â–µ–Ω–∞...</div>
        <div class="log-entry success">[–ì–û–¢–û–í] –û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞...</div>
      </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ -->
    <div class="charts-container">
      <div class="chart-card">
        <h3>üìà –ì—Ä–∞—Ñ–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏</h3>
        <canvas id="memoryChart" width="350" height="200"></canvas>
      </div>

      <div class="chart-card">
        <h3>üìä –ì—Ä–∞—Ñ–∏–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ë–î</h3>
        <canvas id="dbChart" width="350" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  let monitoringInterval = null;
  let refreshInterval = /*[[${refreshInterval}]]*/ 5000;
  let memoryHistory = [];
  let dbHistory = [];
  let isMonitoringActive = false;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  document.addEventListener('DOMContentLoaded', function() {
    addLog('info', '–°—Ç—Ä–∞–Ω–∏—Ü–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    refreshData();
    startMonitoring();
  });

  function showLoading() {
    document.getElementById('loading').style.display = 'block';
  }

  function hideLoading() {
    document.getElementById('loading').style.display = 'none';
  }

  function addLog(type, message) {
    const logsContainer = document.getElementById('systemLogs');
    const timestamp = new Date().toLocaleTimeString('ru-RU');
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry ${type}`;
    logEntry.textContent = `[${timestamp}] ${message}`;

    logsContainer.appendChild(logEntry);
    logsContainer.scrollTop = logsContainer.scrollHeight;

    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤
    if (logsContainer.children.length > 100) {
      logsContainer.removeChild(logsContainer.firstChild);
    }
  }

  async function refreshData() {
    try {
      showLoading();

      const [memoryResponse, systemResponse] = await Promise.all([
        fetch('/diagnostic/memory'),
        fetch('/diagnostic/full-system')
      ]);

      const memoryData = await memoryResponse.json();
      const systemData = await systemResponse.json();

      updateMemoryMetrics(memoryData);
      updateSystemMetrics(systemData);
      updateDatabaseMetrics(systemData.databasePool);

      addLog('success', '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
      hideLoading();

    } catch (error) {
      addLog('error', `–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
      hideLoading();
    }
  }

  function updateMemoryMetrics(data) {
    if (!data) return;

    const usedMB = data.–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è–ü–∞–º—è—Ç—å ? parseInt(data.–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è–ü–∞–º—è—Ç—å) : 0;
    const totalMB = data.–≤—ã–¥–µ–ª–µ–Ω–Ω–∞—è–ü–∞–º—è—Ç—å ? parseInt(data.–≤—ã–¥–µ–ª–µ–Ω–Ω–∞—è–ü–∞–º—è—Ç—å) : 0;
    const maxMB = data.–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è–ü–∞–º—è—Ç—å ? parseInt(data.–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è–ü–∞–º—è—Ç—å) : 0;
    const percent = data.–ø—Ä–æ—Ü–µ–Ω—Ç–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ? parseFloat(data.–ø—Ä–æ—Ü–µ–Ω—Ç–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è) : 0;

    document.getElementById('memoryUsed').textContent = usedMB + ' –ú–ë';
    document.getElementById('memoryAllocated').textContent = totalMB + ' –ú–ë';
    document.getElementById('memoryMax').textContent = maxMB + ' –ú–ë';
    document.getElementById('memoryPercent').textContent = percent.toFixed(1) + '%';

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
    const progressBar = document.getElementById('memoryProgress');
    progressBar.style.width = percent + '%';

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    if (percent > 90) {
      progressBar.className = 'progress-fill critical';
      document.getElementById('memoryPercent').className = 'metric-value critical';
      addLog('warning', `–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: ${percent.toFixed(1)}%`);
    } else if (percent > 75) {
      progressBar.className = 'progress-fill warning';
      document.getElementById('memoryPercent').className = 'metric-value warning';
    } else {
      progressBar.className = 'progress-fill';
      document.getElementById('memoryPercent').className = 'metric-value normal';
    }

    // Heap –ø–∞–º—è—Ç—å
    if (data.heap–ü–∞–º—è—Ç—å) {
      document.getElementById('heapMemory').textContent = data.heap–ü–∞–º—è—Ç—å;
    }
    if (data.nonHeap–ü–∞–º—è—Ç—å) {
      document.getElementById('nonHeapMemory').textContent = data.nonHeap–ü–∞–º—è—Ç—å;
    }
    if (data.—Å–≤–æ–±–æ–¥–Ω–∞—è–ü–∞–º—è—Ç—å) {
      document.getElementById('freeMemory').textContent = data.—Å–≤–æ–±–æ–¥–Ω–∞—è–ü–∞–º—è—Ç—å;
    }

    // –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
    if (data.—Å—Ç–∞—Ç—É—Å–°–∏—Å—Ç–µ–º—ã) {
      const statusElement = document.getElementById('memoryStatus');
      statusElement.textContent = data.—Å—Ç–∞—Ç—É—Å–°–∏—Å—Ç–µ–º—ã;

      if (data.—Å—Ç–∞—Ç—É—Å–°–∏—Å—Ç–µ–º—ã.includes('–ö—Ä–∏—Ç–∏—á–Ω–æ')) {
        statusElement.className = 'metric-value critical';
      } else if (data.—Å—Ç–∞—Ç—É—Å–°–∏—Å—Ç–µ–º—ã.includes('–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞')) {
        statusElement.className = 'metric-value warning';
      } else {
        statusElement.className = 'metric-value normal';
      }
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
    memoryHistory.push({
      time: new Date().toLocaleTimeString(),
      value: percent
    });
    if (memoryHistory.length > 20) {
      memoryHistory.shift();
    }
  }

  function updateSystemMetrics(data) {
    if (!data.system) return;

    const system = data.system;

    if (system.processors) {
      document.getElementById('processors').textContent = system.processors;
    }
    if (system.uptimeMinutes) {
      document.getElementById('uptime').textContent = system.uptimeMinutes + ' –º–∏–Ω';
    }
    if (system.monitoringCycles) {
      document.getElementById('monitoringCycles').textContent = system.monitoringCycles;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
    const statusElement = document.getElementById('systemStatus');
    const memoryPercent = data.memory && data.memory.–ø—Ä–æ—Ü–µ–Ω—Ç–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ?
            parseFloat(data.memory.–ø—Ä–æ—Ü–µ–Ω—Ç–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è) : 0;

    if (memoryPercent > 90) {
      statusElement.innerHTML = '<span class="status-indicator status-critical"></span>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞';
      addAlert('critical', '–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π!');
    } else if (memoryPercent > 75) {
      statusElement.innerHTML = '<span class="status-indicator status-warning"></span>–ü–æ–≤—ã—à–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞';
    } else {
      statusElement.innerHTML = '<span class="status-indicator status-normal"></span>–°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞';
    }
  }

  function updateDatabaseMetrics(dbData) {
    if (!dbData) return;

    document.getElementById('dbActive').textContent = dbData.active || 0;
    document.getElementById('dbIdle').textContent = dbData.idle || 0;
    document.getElementById('dbTotal').textContent = dbData.total || 0;
    document.getElementById('dbWaiting').textContent = dbData.waiting || 0;

    // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è –ë–î
    const dbProgress = document.getElementById('dbProgress');
    const activePercent = dbData.total > 0 ? (dbData.active / dbData.total) * 100 : 0;
    dbProgress.style.width = activePercent + '%';

    if (dbData.waiting > 0) {
      dbProgress.className = 'progress-fill warning';
      addLog('warning', `–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: ${dbData.waiting} —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –æ–∂–∏–¥–∞—é—Ç`);
    } else if (activePercent > 80) {
      dbProgress.className = 'progress-fill warning';
    } else {
      dbProgress.className = 'progress-fill';
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
    dbHistory.push({
      time: new Date().toLocaleTimeString(),
      active: dbData.active,
      total: dbData.total
    });
    if (dbHistory.length > 20) {
      dbHistory.shift();
    }
  }

  function addAlert(type, message) {
    const alertsContainer = document.getElementById('alertsContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.style.cssText = `
                padding: 15px;
                margin: 10px 0;
                border-radius: 8px;
                background: ${type === 'critical' ? '#f8d7da' : '#fff3cd'};
                border-left: 4px solid ${type === 'critical' ? '#dc3545' : '#ffc107'};
                color: ${type === 'critical' ? '#721c24' : '#856404'};
            `;
    alert.innerHTML = `
                <strong>${type === 'critical' ? 'üö® –ö–†–ò–¢–ò–ß–ù–û:' : '‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï:'}</strong>
                ${message}
                <button style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;" onclick="this.parentElement.remove()">√ó</button>
            `;

    alertsContainer.appendChild(alert);

    // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
      if (alert.parentElement) {
        alert.remove();
      }
    }, 30000);
  }

  function startMonitoring() {
    if (isMonitoringActive) return;

    isMonitoringActive = true;
    monitoringInterval = setInterval(refreshData, refreshInterval);
    addLog('info', `–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º ${refreshInterval/1000} —Å–µ–∫`);
  }

  function stopMonitoring() {
    if (!isMonitoringActive) return;

    isMonitoringActive = false;
    if (monitoringInterval) {
      clearInterval(monitoringInterval);
      monitoringInterval = null;
    }
    addLog('warning', '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
  }

  function updateRefreshInterval() {
    const newInterval = parseInt(document.getElementById('refreshInterval').value);
    refreshInterval = newInterval;

    if (isMonitoringActive) {
      stopMonitoring();
      startMonitoring();
    }

    addLog('info', `–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${newInterval/1000} —Å–µ–∫`);
  }

  function clearLogs() {
    const logsContainer = document.getElementById('systemLogs');
    logsContainer.innerHTML = '';
    addLog('info', '–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã');
  }

  // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener('beforeunload', () => {
    if (monitoringInterval) {
      clearInterval(monitoringInterval);
    }
  });

  /*]]>*/
</script>
</body>
</html>