<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Профиль пользователя - Cleopatra</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- ПОДКЛЮЧЕНИЕ ФРАГМЕНТА СТИЛЕЙ -->
    <th:block th:replace="~{fragments/sidebar :: sidebar-styles}"></th:block>

    <style>
        /* Переменные уже определены в sidebar-styles, поэтому убираем дублирование */

        * {
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-accent) 100%);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 400;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Typography Hierarchy */
        .serif-heading {
            font-family: 'Playfair Display', serif;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .sans-serif-body {
            font-family: 'Inter', sans-serif;
            font-weight: 400;
        }

        .text-display {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.03em;
        }

        .text-title {
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .text-subtitle {
            font-size: 1.125rem;
            font-weight: 500;
        }

        .text-caption {
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.01em;
        }

        /* Main Content - адаптируем под фрагмент sidebar */
        .main-content {
            margin-left: 280px;
            margin-right: 380px;
            min-height: 100vh;
            padding: 2rem 0;
        }

        /* Right Sidebar */
        .right-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: 380px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-primary);
            padding: 2rem 1.5rem;
            overflow-y: auto;
            box-shadow: var(--shadow-sm);
        }

        /* Profile Container */
        .profile-container {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            margin: 0 2rem;
        }

        /* Cover Section */
        .cover-section {
            height: 280px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        .cover-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .cover-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 0.1) 100%);
        }

        /* Profile Header */
        .profile-header {
            position: relative;
            padding: 0 2.5rem;
            background: var(--bg-secondary);
        }

        .profile-avatar-container {
            position: absolute;
            top: -80px;
            left: 2.5rem;
            z-index: 10;
        }

        .profile-avatar {
            width: 160px;
            height: 160px;
            border: 6px solid var(--bg-secondary);
            border-radius: 50%;
            background: var(--bg-accent);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            position: relative;
        }

        .avatar-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .default-avatar {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--bg-accent), #f1f5f9);
            color: var(--text-muted);
        }

        /* Profile Actions */
        .profile-actions {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .btn-luxury {
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 0.875rem;
            letter-spacing: 0.01em;
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border-primary);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }

        .btn-luxury::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-luxury:hover::before {
            left: 100%;
        }

        .btn-primary-luxury {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-color: transparent;
            box-shadow: var(--shadow-md);
        }

        .btn-primary-luxury:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            color: white;
        }

        .btn-secondary-luxury {
            background: var(--surface-elevated);
            color: var(--text-primary);
            border-color: var(--border-secondary);
        }

        .btn-secondary-luxury:hover {
            background: var(--bg-accent);
            color: var(--text-primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-danger-luxury {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            border-color: transparent;
        }

        .btn-danger-luxury:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
            color: white;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* Profile Info */
        .profile-info {
            padding: 6rem 2.5rem 2.5rem;
        }

        .profile-name {
            font-family: 'Playfair Display', serif;
            font-size: 2.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .profile-username {
            font-size: 1.125rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            font-weight: 400;
        }

        .profile-meta {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .meta-icon {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }

        /* Stats Section */
        .stats-section {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            padding: 1.5rem 0;
            border-top: 1px solid var(--border-secondary);
            border-bottom: 1px solid var(--border-secondary);
        }

        .stat-item {
            text-decoration: none;
            color: inherit;
            transition: all 0.2s;
        }

        .stat-item:hover {
            color: var(--accent-primary);
            transform: translateY(-1px);
        }

        .stat-number {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Navigation Tabs */
        .profile-nav {
            margin-bottom: 0;
        }

        .nav-tabs-luxury {
            border: none;
            gap: 0.5rem;
        }

        .nav-tab-luxury {
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
            letter-spacing: 0.01em;
            border-radius: var(--radius-md);
            transition: all 0.2s;
            position: relative;
        }

        .nav-tab-luxury:hover {
            background: var(--bg-accent);
            color: var(--text-primary);
        }

        .nav-tab-luxury.active {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(124, 58, 237, 0.1));
            color: var(--accent-primary);
        }

        .nav-tab-luxury.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 2px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 1px;
        }

        /* Content Area */
        .content-area {
            padding: 2.5rem;
            min-height: 400px;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--bg-accent), #f1f5f9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            color: var(--text-muted);
            font-size: 2rem;
        }

        .empty-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .empty-description {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Right Sidebar Widgets */
        .widget {
            background: var(--surface-elevated);
            border-radius: var(--radius-lg);
            margin-bottom: 1.5rem;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-secondary);
        }

        .widget-header {
            padding: 1.5rem 1.5rem 1rem;
            border-bottom: 1px solid var(--border-secondary);
        }

        .widget-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .widget-content {
            padding: 1rem 1.5rem 1.5rem;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-secondary);
            transition: all 0.2s;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background: var(--bg-accent);
            margin: 0 -1.5rem;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            border-radius: var(--radius-sm);
        }

        .suggestion-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--bg-accent), #f1f5f9);
            margin-right: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .suggestion-info {
            flex: 1;
        }

        .suggestion-name {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
            margin: 0 0 0.25rem;
        }

        .suggestion-handle {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin: 0;
        }

        .btn-follow {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .btn-follow:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
        }

        /* Alerts */
        .alert-luxury {
            border: none;
            border-radius: var(--radius-md);
            margin: 2rem;
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .alert-success-luxury {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.1), rgba(16, 185, 129, 0.1));
            color: var(--accent-success);
            border-left: 4px solid var(--accent-success);
        }

        .alert-danger-luxury {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(248, 113, 113, 0.1));
            color: #dc2626;
            border-left: 4px solid #dc2626;
        }

        /* Адаптация под мобильные устройства с учетом фрагмента */
        @media (max-width: 1400px) {
            .right-sidebar {
                display: none;
            }
            .main-content {
                margin-right: 0;
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                margin-left: 80px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                margin-top: 60px;
                padding: 1rem 0;
            }

            .profile-container {
                margin: 0 1rem;
            }

            .profile-header, .profile-info, .content-area {
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }

            .profile-avatar-container {
                left: 1.5rem;
            }

            .profile-actions {
                justify-content: flex-start;
                gap: 0.5rem;
            }

            .btn-luxury {
                padding: 0.625rem 1rem;
                font-size: 0.8125rem;
                flex: 1;
                min-width: 100px;
                text-align: center;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .profile-actions {
                flex-direction: column;
                gap: 0.75rem;
            }

            .btn-luxury {
                width: 100%;
                flex: none;
            }

            .profile-info {
                padding-top: 5rem;
            }
        }

        /* Стили для рекомендаций (из оригинального кода) */
        .suggestion-avatar-link {
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .suggestion-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .suggestion-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(212, 175, 55, 0.3);
        }

        .suggestion-name-link {
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .suggestion-name {
            margin: 0;
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.2s ease;
            cursor: pointer;
        }

        .suggestion-name-link:hover .suggestion-name {
            color: var(--accent-primary);
        }

        .suggestion-handle-link {
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .suggestion-handle {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
            transition: color 0.2s ease;
            cursor: pointer;
        }

        .suggestion-handle-link:hover .suggestion-handle {
            color: var(--accent-primary);
        }

        .widget-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-accent);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        .btn-show-all {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.75rem;
            background: transparent;
            color: var(--accent-primary);
            text-decoration: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .btn-show-all:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }

        .no-recommendations {
            padding: 2rem 1rem;
        }

        .empty-state {
            text-align: center;
            padding: 1rem;
        }

        .empty-state p {
            margin: 0;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background: var(--bg-accent);
            border-radius: var(--radius-md);
        }

        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            transition: border-color 0.2s ease;
        }

        .suggestion-avatar:hover .avatar-img {
            border-color: var(--accent-primary);
        }

        .suggestion-info {
            flex: 1;
            min-width: 0;
        }

        .suggestion-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin: 0.25rem 0 0 0;
        }

        .btn-follow {
            padding: 0.5rem 1rem;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .btn-follow:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
        }
    </style>


</head>
<body th:data-current-user-id="${currentUserId}"
      th:data-profile-user-id="${user.id}"
      th:data-is-subscribed="${isSubscribed ?: false}">

<!-- ПОДКЛЮЧЕНИЕ МОБИЛЬНОГО ХЕДЕРА ИЗ ФРАГМЕНТА -->
<th:block th:replace="~{fragments/sidebar :: mobile-header}"></th:block>

<!-- ПОДКЛЮЧЕНИЕ SIDEBAR ИЗ ФРАГМЕНТА С УКАЗАНИЕМ АКТИВНОЙ СЕКЦИИ -->
<th:block th:replace="~{fragments/sidebar :: sidebar('profile')}"></th:block>

<!-- Main Content -->
<main class="main-content">

    <div style="display: none;"
         th:text="'Debug: user.id=' + ${user.id} + ', currentUserId=' + ${currentUserId} + ', isSubscribed=' + ${isSubscribed}">
    </div>
    <!-- Success/Error Messages -->
    <div th:if="${successMessage}" class="alert-luxury alert-success-luxury">
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${successMessage}"></span>
    </div>

    <div th:if="${errorMessage}" class="alert-luxury alert-danger-luxury">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span th:text="${errorMessage}"></span>
    </div>

    <!-- Profile Container -->
    <div class="profile-container">
        <!-- Cover Section -->
        <div class="cover-section">
            <img th:if="${user.imgBackground}"
                 th:src="${user.imgBackground}"
                 alt="Cover"
                 class="cover-image">
            <div class="cover-overlay"></div>
        </div>

        <!-- Profile Header -->
        <div class="profile-header">
            <!-- Avatar -->
            <div class="profile-avatar-container">
                <div class="profile-avatar">
                    <img th:if="${user.imageUrl}"
                         th:src="${user.imageUrl}"
                         alt="Аватар"
                         class="avatar-image">
                    <div th:unless="${user.imageUrl}" class="default-avatar">
                        <i class="fas fa-user fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Info -->
        <div class="profile-info">
            <h1 class="profile-name">
                <th:block th:if="${!#strings.isEmpty(user.firstName) || !#strings.isEmpty(user.lastName)}">
                    <span th:text="${user.firstName ?: ''}"></span>
                    <span th:text="${user.lastName ?: ''}"></span>
                </th:block>
                <th:block th:unless="${!#strings.isEmpty(user.firstName) || !#strings.isEmpty(user.lastName)}">
                    Добро пожаловать
                </th:block>
            </h1>
            <p class="profile-username" th:text="'@' + ${user.email.split('@')[0]}"></p>


            <div class="profile-actions">
                <!-- Кнопки для ЧУЖОГО профиля -->
                <th:block th:if="${currentUserId != null and currentUserId != user.id}">

                    <a href="#" class="btn-luxury btn-secondary-luxury" onclick="sendMessage()">
                        <i class="fas fa-envelope"></i>
                        <span>Сообщение</span>
                    </a>

                    <!-- ПРОСТАЯ кнопка подписки -->
                    <button type="button"
                            id="follow-btn"
                            th:class="${isSubscribed} ? 'btn-luxury btn-secondary-luxury' : 'btn-luxury btn-primary-luxury'"
                            onclick="simpleToggleFollow()">
                        <i th:class="${isSubscribed} ? 'fas fa-user-check' : 'fas fa-user-plus'" id="follow-icon"></i>
                        <span id="follow-text" th:text="${isSubscribed} ? 'Подписан' : 'Подписаться'">Подписаться</span>
                    </button>

                    <button type="button" onclick="shareProfile()" class="btn-luxury btn-secondary-luxury">
                        <i class="fas fa-share"></i>
                        <span>Поделиться</span>
                    </button>

                    <a href="#" class="btn-luxury btn-danger-luxury" onclick="blockUser()">
                        <i class="fas fa-ban"></i>
                        <span>Заблокировать</span>
                    </a>
                </th:block>

                <!-- Кнопки для СОБСТВЕННОГО профиля -->
                <th:block th:if="${currentUserId != null and currentUserId == user.id}">

                    <a th:href="@{/profile/{userId}/edit(userId=${user.id})}" class="btn-luxury btn-primary-luxury">
                        <i class="fas fa-edit"></i>
                        <span>Редактировать профиль</span>
                    </a>

                    <a th:href="@{/showProfileStats/{userId}/stats(userId=${user.id})}" class="btn-luxury btn-secondary-luxury">
                        <i class="fas fa-chart-bar"></i>
                        <span>Статистика</span>
                    </a>
                </th:block>

                <!-- Если никакие условия не сработали -->
                <div th:if="${currentUserId == null}">
                    <p style="color: red;">❌ Пользователь не авторизован</p>
                </div>
            </div>

            <!-- Meta Information -->
            <div class="profile-meta">
                <div class="meta-item">
                    <i class="fas fa-calendar-alt meta-icon"></i>
                    <span th:text="'Присоединился ' + ${#temporals.format(user.createdAt, 'MMMM yyyy', new java.util.Locale('ru'))}"></span>
                </div>

                <div class="meta-item">
                    <i class="fas fa-map-marker-alt meta-icon"></i>
                    <span th:if="${user.city != null and !#strings.isEmpty(user.city)}" th:text="${user.city}"></span>
                    <span th:if="${user.city == null or #strings.isEmpty(user.city)}">Местоположение не указано</span>
                </div>
            </div>


            <!-- Stats Section с правильными ссылками -->
            <div class="stats-section">
                <a th:href="@{/subscriptions/{userId}/following(userId=${user.id})}" class="stat-item">
                    <span class="stat-number" th:text="${user.followingCount ?: 0}">0</span>
                    <span class="stat-label">Подписок</span>
                </a>
                <a th:href="@{/subscriptions/{userId}/followers(userId=${user.id})}" class="stat-item">
                    <span class="stat-number" th:text="${user.followersCount ?: 0}">0</span>
                    <span class="stat-label">Подписчиков</span>
                </a>
                <a href="#" class="stat-item">
                    <span class="stat-number" th:text="${user.postsCount ?: 0}">0</span>
                    <span class="stat-label">Постов</span>
                </a>
            </div>

            <!-- Navigation Tabs -->
            <div class="profile-nav">
                <div class="nav-tabs-luxury d-flex">
                    <button class="nav-tab-luxury active">Посты</button>
                    <button class="nav-tab-luxury">Ответы</button>
                    <button class="nav-tab-luxury">Медиа</button>
                    <button class="nav-tab-luxury">Нравится</button>
                </div>
            </div>
        </div>





        <!-- Content Area -->
        <!-- Content Area - заменить существующий блок -->
        <div class="content-area">

            <!-- Если есть посты -->
            <div th:if="${posts != null and !posts.posts.empty}">

                <!-- Список постов -->
                <div class="posts-container">
                    <!-- Обновленная статья поста с навигацией -->
                    <article class="post-card" th:each="post : ${posts.posts}">

                        <!-- Заголовок поста с автором -->
                        <div class="post-header">
                            <!-- Аватар автора -->
                            <a th:href="@{/profile/{userId}(userId=${post.author.id})}" class="author-avatar-link">
                                <div class="author-avatar">
                                    <img th:if="${post.author.imageUrl}"
                                         th:src="${post.author.imageUrl}"
                                         th:alt="${post.author.firstName + ' ' + post.author.lastName}"
                                         class="avatar-img">
                                    <div th:unless="${post.author.imageUrl}" class="default-avatar-small">
                                        <span th:text="${#strings.substring(post.author.firstName, 0, 1) + #strings.substring(post.author.lastName, 0, 1)}">AB</span>
                                    </div>
                                </div>
                            </a>

                            <!-- Информация об авторе -->
                            <div class="author-info">
                                <div class="author-main">
                                    <a th:href="@{/profile/{userId}(userId=${post.author.id})}" class="author-name">
                                        <span th:text="${post.author.firstName + ' ' + post.author.lastName}">Имя Автора</span>
                                    </a>
                                    <span class="author-handle" th:text="'@' + ${post.author.firstName?.toLowerCase()}">@автор</span>
                                    <!-- Дата теперь ссылка на пост -->
                                    <a th:href="@{/posts/{id}(id=${post.id})}" class="post-date-link">
                                        <span class="post-date" th:text="${#temporals.format(post.createdAt, 'dd MMM', new java.util.Locale('ru'))}">1 янв</span>
                                    </a>
                                </div>
                            </div>

                            <!-- Меню поста -->
                            <div class="post-menu">
                                <button class="post-menu-btn" onclick="togglePostMenu(this)">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                                <div class="post-menu-dropdown">
                                    <a th:href="@{/posts/{id}(id=${post.id})}" class="menu-item">
                                        <i class="fas fa-link"></i>
                                        Перейти к посту
                                    </a>
                                    <a href="#" class="menu-item" onclick="copyPostLink(this)" th:data-post-id="${post.id}">
                                        <i class="fas fa-copy"></i>
                                        Копировать ссылку
                                    </a>
                                    <a href="#" class="menu-item" th:if="${isOwnProfile}">
                                        <i class="fas fa-edit"></i>
                                        Редактировать
                                    </a>
                                    <a href="#" class="menu-item danger" th:if="${isOwnProfile}">
                                        <i class="fas fa-trash"></i>
                                        Удалить
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Содержимое поста - теперь кликабельное -->
                        <div class="post-content" onclick="navigateToPost(event, this)" th:data-post-id="${post.id}">
                            <!-- Текст поста -->
                            <div class="post-text" th:if="${post.content != null and !#strings.isEmpty(post.content)}">
                                <p th:text="${post.content}">Текст поста...</p>
                                <span th:if="${post.isLongContent}" class="read-more-link">
                <a th:href="@{/posts/{id}(id=${post.id})}">Читать далее</a>
            </span>
                            </div>

                            <!-- Изображение поста -->
                            <div class="post-media" th:if="${post.hasImage}">
                                <div class="media-container">
                                    <img th:src="${post.imageUrl}"
                                         alt="Изображение поста"
                                         class="post-image">
                                </div>
                            </div>
                        </div>

                        <!-- Действия с постом -->
                        <div class="post-actions">
                            <button class="action-btn comment-btn" onclick="openComments(this)"
                                    th:data-post-id="${post.id}">
                                <i class="far fa-comment"></i>
                                <span th:text="${post.commentsCount}">0</span>
                            </button>

                            <button class="action-btn like-btn" onclick="toggleLike(this)"
                                    th:data-post-id="${post.id}">
                                <i class="far fa-heart"></i>
                                <span th:text="${post.likesCount}">0</span>
                            </button>

                            <button class="action-btn share-btn" onclick="sharePost(this)"
                                    th:data-post-id="${post.id}">
                                <i class="fas fa-share"></i>
                            </button>

                            <div class="action-stats">
            <span class="views-count">
                <i class="far fa-eye"></i>
                <span th:text="${post.viewsCount}">0</span>
            </span>
                            </div>
                        </div>
                    </article>

                    <style>
                        /* Дополнительные стили для навигации */
                        .post-content {
                            cursor: pointer;
                            transition: background-color 0.2s ease;
                        }

                        .post-content:hover {
                            background-color: rgba(0, 0, 0, 0.02);
                        }

                        .post-date-link {
                            text-decoration: none;
                            color: inherit;
                            transition: color 0.2s ease;
                        }

                        .post-date-link:hover {
                            color: var(--accent-primary, #2563eb);
                        }

                        .post-date-link:hover .post-date {
                            text-decoration: underline;
                        }

                        .media-container {
                            display: block;
                            cursor: pointer;
                        }

                        /* Отключаем pointer events для вложенных интерактивных элементов при клике на контент */
                        .post-content .read-more-link {
                            pointer-events: auto;
                            position: relative;
                            z-index: 2;
                        }
                    </style>

                    <script>
                        // Навигация к посту при клике на контент
                        function navigateToPost(event, element) {
                            // Не переходим если кликнули на ссылку "Читать далее"
                            if (event.target.closest('.read-more-link')) {
                                return;
                            }

                            // Не переходим если кликнули на изображение (оно уже кликабельно)
                            if (event.target.closest('.post-image')) {
                                return;
                            }

                            const postId = element.dataset.postId;
                            if (postId) {
                                window.location.href = `/posts/${postId}`;
                            }
                        }

                        // Копирование ссылки на пост
                        function copyPostLink(element) {
                            const postId = element.dataset.postId;
                            const postUrl = `${window.location.origin}/posts/${postId}`;

                            navigator.clipboard.writeText(postUrl).then(() => {
                                // Показываем уведомление (если у вас есть функция showNotification)
                                if (typeof showNotification === 'function') {
                                    showNotification('Ссылка на пост скопирована!', 'success');
                                } else {
                                    alert('Ссылка скопирована в буфер обмена!');
                                }
                            }).catch(err => {
                                console.error('Ошибка при копировании: ', err);
                                alert('Не удалось скопировать ссылку');
                            });
                        }

                        // Обновленная функция открытия комментариев - переход к посту
                        function openComments(btn) {
                            const postId = btn.dataset.postId;
                            window.location.href = `/posts/${postId}#comments`;
                        }

                        // Обновленная функция для кнопки поделиться
                        function sharePost(btn) {
                            const postId = btn.dataset.postId;
                            const postUrl = `${window.location.origin}/posts/${postId}`;

                            if (navigator.share) {
                                navigator.share({
                                    title: 'Пост',
                                    url: postUrl
                                });
                            } else {
                                navigator.clipboard.writeText(postUrl).then(() => {
                                    if (typeof showNotification === 'function') {
                                        showNotification('Ссылка на пост скопирована!', 'success');
                                    } else {
                                        alert('Ссылка скопирована в буфер обмена!');
                                    }
                                });
                            }
                        }
                    </script>
                </div>

                <!-- Пагинация -->
                <div class="pagination-container" th:if="${posts.hasNext or posts.hasPrevious}">
                    <button th:if="${posts.hasPrevious}"
                            th:onclick="'loadPage(' + ${posts.previousPage} + ')'"
                            class="btn-luxury btn-secondary-luxury">
                        <i class="fas fa-chevron-left"></i>
                        Предыдущая
                    </button>

                    <span class="page-info">
                Страница <span th:text="${posts.currentPage + 1}">1</span>
            </span>

                    <button th:if="${posts.hasNext}"
                            th:onclick="'loadPage(' + ${posts.nextPage} + ')'"
                            class="btn-luxury btn-primary-luxury">
                        Следующая
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <!-- Кнопка "Загрузить еще" для бесконечного скролла -->
                <div class="load-more-container" th:if="${posts.hasNext}">
                    <button id="loadMoreBtn"
                            onclick="loadMorePosts()"
                            class="btn-luxury btn-secondary-luxury load-more-btn">
                        <i class="fas fa-plus"></i>
                        Загрузить еще посты
                    </button>
                </div>
            </div>

            <!-- Если постов нет -->
            <div th:unless="${posts != null and !posts.posts.empty}" class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-feather-alt"></i>
                </div>
                <h3 class="empty-title" th:text="${isOwnProfile ? 'Ваша история начинается здесь' : 'Пока нет постов'}">
                    Ваша история начинается здесь
                </h3>
                <p class="empty-description" th:text="${isOwnProfile ? 'Поделитесь своими мыслями и начните создавать свой уникальный контент' : 'Этот пользователь еще не публиковал посты'}">
                    Поделитесь своими мыслями и начните создавать свой уникальный контент
                </p>
                <a th:if="${isOwnProfile}"
                   href="/posts/create"
                   class="btn-luxury btn-primary-luxury">
                    <i class="fas fa-plus"></i>
                    Создать первый пост
                </a>
            </div>
        </div>

        <style>
            /* Стили для постов */
            .posts-container {
                display: flex;
                flex-direction: column;
                gap: 0;
            }

            .post-card {
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border-secondary);
                padding: 1.5rem;
                transition: all 0.2s ease;
                cursor: pointer;
            }

            .post-card:hover {
                background: var(--bg-accent);
            }

            .post-card:last-child {
                border-bottom: none;
                border-radius: 0 0 var(--radius-xl) var(--radius-xl);
            }

            /* Заголовок поста */
            .post-header {
                display: flex;
                align-items: flex-start;
                gap: 0.75rem;
                margin-bottom: 1rem;
                position: relative;
            }

            .author-avatar-link {
                text-decoration: none;
                flex-shrink: 0;
            }

            .author-avatar {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                overflow: hidden;
                border: 2px solid var(--border-primary);
                transition: all 0.2s ease;
            }

            .author-avatar:hover {
                transform: scale(1.05);
                border-color: var(--accent-primary);
            }

            .avatar-img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .default-avatar-small {
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 600;
                font-size: 1rem;
            }

            .author-info {
                flex: 1;
                min-width: 0;
            }

            .author-main {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                flex-wrap: wrap;
            }

            .author-name {
                font-weight: 600;
                color: var(--text-primary);
                text-decoration: none;
                transition: color 0.2s ease;
            }

            .author-name:hover {
                color: var(--accent-primary);
            }

            .author-handle {
                color: var(--text-secondary);
                font-size: 0.875rem;
            }

            .post-date {
                color: var(--text-muted);
                font-size: 0.875rem;
            }

            .post-date::before {
                content: '·';
                margin: 0 0.5rem;
                color: var(--text-muted);
            }

            /* Меню поста */
            .post-menu {
                position: relative;
            }

            .post-menu-btn {
                background: none;
                border: none;
                color: var(--text-muted);
                padding: 0.5rem;
                border-radius: 50%;
                transition: all 0.2s ease;
                cursor: pointer;
            }

            .post-menu-btn:hover {
                background: var(--bg-accent);
                color: var(--text-primary);
            }

            .post-menu-dropdown {
                position: absolute;
                top: 100%;
                right: 0;
                background: var(--bg-secondary);
                border: 1px solid var(--border-primary);
                border-radius: var(--radius-md);
                box-shadow: var(--shadow-lg);
                min-width: 180px;
                z-index: 1000;
                display: none;
            }

            .post-menu-dropdown.show {
                display: block;
            }

            .menu-item {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.75rem 1rem;
                color: var(--text-primary);
                text-decoration: none;
                transition: background 0.2s ease;
                font-size: 0.875rem;
            }

            .menu-item:hover {
                background: var(--bg-accent);
                color: var(--text-primary);
            }

            .menu-item.danger {
                color: #dc2626;
            }

            .menu-item.danger:hover {
                background: rgba(220, 38, 38, 0.1);
                color: #dc2626;
            }

            /* Содержимое поста */
            .post-content {
                margin-bottom: 1rem;
            }

            .post-text {
                margin-bottom: 1rem;
                line-height: 1.6;
            }

            .post-text p {
                margin: 0;
                color: var(--text-primary);
                white-space: pre-wrap;
                word-wrap: break-word;
            }

            .read-more-link {
                color: var(--accent-primary);
                font-size: 0.875rem;
            }

            .read-more-link a {
                color: inherit;
                text-decoration: none;
            }

            .read-more-link a:hover {
                text-decoration: underline;
            }

            /* Медиа контент */
            .post-media {
                margin-bottom: 1rem;
                border-radius: var(--radius-lg);
                overflow: hidden;
                border: 1px solid var(--border-primary);
            }

            .media-link {
                display: block;
                text-decoration: none;
            }

            .post-image {
                width: 100%;
                max-height: 400px;
                object-fit: cover;
                transition: transform 0.2s ease;
            }

            .post-image:hover {
                transform: scale(1.02);
            }

            /* Действия с постом */
            .post-actions {
                display: flex;
                align-items: center;
                gap: 1rem;
                padding-top: 0.75rem;
                border-top: 1px solid var(--border-secondary);
            }

            .action-btn {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                background: none;
                border: none;
                color: var(--text-muted);
                padding: 0.5rem 0.75rem;
                border-radius: var(--radius-md);
                font-size: 0.875rem;
                transition: all 0.2s ease;
                cursor: pointer;
            }

            .action-btn:hover {
                background: var(--bg-accent);
                color: var(--text-primary);
            }

            .comment-btn:hover {
                color: #3b82f6;
                background: rgba(59, 130, 246, 0.1);
            }

            .like-btn:hover {
                color: #ef4444;
                background: rgba(239, 68, 68, 0.1);
            }

            .like-btn.liked {
                color: #ef4444;
            }

            .like-btn.liked i {
                color: #ef4444;
            }

            .share-btn:hover {
                color: #10b981;
                background: rgba(16, 185, 129, 0.1);
            }

            .action-stats {
                margin-left: auto;
                display: flex;
                align-items: center;
                gap: 1rem;
            }

            .views-count {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                color: var(--text-muted);
                font-size: 0.875rem;
            }

            /* Пагинация */
            .pagination-container {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 2rem;
                border-top: 1px solid var(--border-secondary);
            }

            .page-info {
                color: var(--text-secondary);
                font-size: 0.875rem;
            }

            .load-more-container {
                padding: 2rem;
                text-align: center;
                border-top: 1px solid var(--border-secondary);
            }

            .load-more-btn {
                width: 100%;
                max-width: 300px;
            }

            /* Мобильная адаптация */
            @media (max-width: 768px) {
                .post-card {
                    padding: 1rem;
                }

                .author-main {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 0.25rem;
                }

                .author-handle,
                .post-date {
                    font-size: 0.8125rem;
                }

                .post-actions {
                    gap: 0.5rem;
                }

                .action-btn {
                    padding: 0.5rem;
                    font-size: 0.8125rem;
                }

                .pagination-container {
                    flex-direction: column;
                    gap: 1rem;
                }
            }
        </style>

        <script>
            // JavaScript функции для работы с постами
            function togglePostMenu(btn) {
                const dropdown = btn.nextElementSibling;
                const isOpen = dropdown.classList.contains('show');

                // Закрываем все открытые меню
                document.querySelectorAll('.post-menu-dropdown').forEach(menu => {
                    menu.classList.remove('show');
                });

                // Открываем/закрываем текущее меню
                if (!isOpen) {
                    dropdown.classList.add('show');
                }
            }

            function openComments(btn) {
                const postId = btn.dataset.postId;
                // TODO: Открыть модальное окно с комментариями или перейти к посту
                window.location.href = `/posts/${postId}`;
            }

            function toggleLike(btn) {
                const postId = btn.dataset.postId;
                const icon = btn.querySelector('i');
                const count = btn.querySelector('span');

                // TODO: Отправить AJAX запрос для лайка
                btn.classList.toggle('liked');

                if (btn.classList.contains('liked')) {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    count.textContent = parseInt(count.textContent) + 1;
                } else {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    count.textContent = parseInt(count.textContent) - 1;
                }
            }

            function sharePost(btn) {
                const postId = btn.dataset.postId;
                const url = window.location.origin + `/posts/${postId}`;

                if (navigator.share) {
                    navigator.share({
                        title: 'Пост',
                        url: url
                    });
                } else {
                    navigator.clipboard.writeText(url).then(() => {
                        // TODO: Показать уведомление
                        alert('Ссылка скопирована!');
                    });
                }
            }

            function loadPage(page) {
                const currentUrl = new URL(window.location);
                currentUrl.searchParams.set('page', page);
                window.location.href = currentUrl.toString();
            }

            function loadMorePosts() {
                // TODO: Реализовать AJAX загрузку дополнительных постов
                console.log('Загрузка дополнительных постов...');
            }

            // Закрытие меню при клике вне его
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.post-menu')) {
                    document.querySelectorAll('.post-menu-dropdown').forEach(menu => {
                        menu.classList.remove('show');
                    });
                }
            });
        </script>


    </div>
</main>

<!-- Right Sidebar -->
<aside class="right-sidebar">
    <!-- Trending Topics -->
    <div class="widget">
        <div class="widget-header">
            <h3 class="widget-title">Актуальные темы</h3>
        </div>
        <div class="widget-content">
            <div class="suggestion-item">
                <div class="suggestion-info">
                    <p class="suggestion-name">#Технологии</p>
                    <p class="suggestion-handle">1.2M обсуждений</p>
                </div>
            </div>
            <div class="suggestion-item">
                <div class="suggestion-info">
                    <p class="suggestion-name">#Дизайн</p>
                    <p class="suggestion-handle">845K обсуждений</p>
                </div>
            </div>
            <div class="suggestion-item">
                <div class="suggestion-info">
                    <p class="suggestion-name">#Искусство</p>
                    <p class="suggestion-handle">654K обсуждений</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendations -->
    <div class="widget">
        <div class="widget-header">
            <h3 class="widget-title">Рекомендации</h3>
        </div>
        <div class="widget-content">
            <!-- Проверяем, есть ли рекомендации -->
            <div th:if="${recommendations != null and !recommendations.empty}">
                <div class="suggestion-item" th:each="recommendation : ${recommendations}">
                    <!-- Кликабельная аватарка -->
                    <a th:href="@{/profile/{userId}(userId=${recommendation.id})}" class="suggestion-avatar-link">
                        <div class="suggestion-avatar">
                            <img th:src="${recommendation.imageUrl != null ? recommendation.imageUrl : '/images/default-avatar.png'}"
                                 th:alt="${recommendation.firstName + ' ' + recommendation.lastName}"
                                 class="avatar-img">
                        </div>
                    </a>

                    <div class="suggestion-info">
                        <!-- Кликабельное имя -->
                        <a th:href="@{/profile/{userId}(userId=${recommendation.id})}" class="suggestion-name-link">
                            <p class="suggestion-name"
                               th:text="${recommendation.firstName + ' ' + recommendation.lastName}">
                                Анна Смирнова
                            </p>
                        </a>

                        <p class="suggestion-meta"
                           th:if="${recommendation.followersCount != null and recommendation.followersCount > 0}">
                            <span th:text="${recommendation.followersCount}">150</span> подписчиков
                        </p>
                    </div>
                    <button class="btn-follow"
                            th:data-user-id="${recommendation.id}"
                            th:text="${recommendation.isFollowing ? 'Читаю' : 'Читать'}">
                        Читать
                    </button>
                </div>
            </div>

            <!-- Сообщение если нет рекомендаций -->
            <div th:if="${recommendations == null or recommendations.empty}" class="no-recommendations">
                <div class="empty-state">
                    <i class="fas fa-users" style="font-size: 2rem; color: var(--text-muted); margin-bottom: 1rem;"></i>
                    <p style="color: var(--text-muted); text-align: center;">
                        Пока нет рекомендаций.<br>
                        Попробуйте позже!
                    </p>
                </div>
            </div>
        </div>

        <!-- Footer с кнопкой "Посмотреть всех" -->
        <div class="widget-footer" th:if="${recommendations != null and !recommendations.empty}">
            <a th:href="@{/recommendations}" class="btn-show-all">
                <span>Посмотреть всех</span>
                <i class="fas fa-arrow-right"></i>
            </a>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="widget">
        <div class="widget-header">
            <h3 class="widget-title">Ваша активность</h3>
        </div>
        <div class="widget-content">
            <div class="suggestion-item">
                <div class="suggestion-info">
                    <p class="suggestion-name">Просмотры профиля</p>
                    <p class="suggestion-handle">24 за эту неделю</p>
                </div>
            </div>
            <div class="suggestion-item">
                <div class="suggestion-info">
                    <p class="suggestion-name">Взаимодействия</p>
                    <p class="suggestion-handle">12 новых лайков</p>
                </div>
            </div>
        </div>
    </div>
</aside>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<!-- ПОДКЛЮЧЕНИЕ СКРИПТОВ ИЗ ФРАГМЕНТА -->
<th:block th:replace="~{fragments/sidebar :: sidebar-scripts}"></th:block>


<script>
    // Инициализация других функций профиля
    document.addEventListener('DOMContentLoaded', function() {
        // Smooth hover animations
        document.querySelectorAll('.btn-luxury:not([data-action="follow"])').forEach(btn => {
            btn.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-2px)';
            });

            btn.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });

        // Tab switching functionality
        document.querySelectorAll('.nav-tab-luxury').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.nav-tab-luxury').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                const emptyTitle = document.querySelector('.empty-title');
                const emptyDescription = document.querySelector('.empty-description');

                switch(this.textContent.trim()) {
                    case 'Посты':
                        emptyTitle.textContent = 'Ваша история начинается здесь';
                        emptyDescription.textContent = 'Поделитесь своими мыслями и начните создавать свой уникальный контент';
                        break;
                    case 'Ответы':
                        emptyTitle.textContent = 'Пока нет ответов';
                        emptyDescription.textContent = 'Ваши ответы на посты других пользователей будут отображаться здесь';
                        break;
                    case 'Медиа':
                        emptyTitle.textContent = 'Медиа контент отсутствует';
                        emptyDescription.textContent = 'Фотографии и видео из ваших постов будут собраны в этом разделе';
                        break;
                    case 'Нравится':
                        emptyTitle.textContent = 'Нет отмеченных постов';
                        emptyDescription.textContent = 'Посты, которые вам понравились, будут сохранены здесь';
                        break;
                }
            });
        });

        // Другие функции...
    });

    // Заглушки для других функций (можно также вынести в отдельные модули)
    function sendMessage() {
        console.log('Отправка сообщения...');
        // TODO: Реализовать логику отправки сообщения
    }

    function shareProfile() {
        if (navigator.share) {
            navigator.share({
                title: document.title,
                url: window.location.href
            });
        } else {
            // Fallback для старых браузеров
            navigator.clipboard.writeText(window.location.href).then(() => {
                window.subscriptionManager?.showNotification('Ссылка скопирована!', 'success');
            });
        }
    }

    function blockUser() {
        if (confirm('Вы уверены, что хотите заблокировать этого пользователя?')) {
            console.log('Блокировка пользователя...');
            // TODO: Реализовать логику блокировки
        }
    }
</script>

<!-- В конце body, перед закрывающим тегом -->
<script>
    // Простые функции
    function sendMessage() { alert('В разработке'); }
    function shareProfile() { /* код */ }
    function blockUser() { /* код */ }
</script>

<!-- Модуль подписок загружается последним -->
<script th:src="@{/js/profile/subscriptionActions.js}"></script>

<!-- Подключаем ваши собственные модули в правильном порядке -->
<script th:src="@{/js/profile/notifications.js}"></script>
<script th:src="@{/js/profile/apiClient.js}"></script>
<script th:src="@{/js/profile/userActions.js}"></script>
<script th:src="@{/js/profile/profileUtils.js}"></script>




</body>
</html>

