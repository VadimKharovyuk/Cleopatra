<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ –¢–µ—Å—Ç Activity Tracker</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .status-panel {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button.danger {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        }

        button.success {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
        }

        .log-panel {
            background: #1a202c;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 20px 0;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #4299e1;
            padding-left: 10px;
        }

        .log-success { border-left-color: #48bb78; color: #9ae6b4; }
        .log-error { border-left-color: #f56565; color: #feb2b2; }
        .log-warning { border-left-color: #ed8936; color: #fbd38d; }
        .log-info { border-left-color: #4299e1; color: #90cdf4; }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .activity-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #48bb78;
            animation: pulse 2s infinite;
            margin-right: 8px;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(72, 187, 120, 0); }
            100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
        }

        .offline { background: #e53e3e; }

        .console-command {
            background: #2d3748;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
            border-left: 4px solid #4299e1;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üß™ Activity Tracker Test</h1>

    <div class="status-panel">
        <h3><span class="activity-indicator" id="indicator"></span>–°—Ç–∞—Ç—É—Å —Ç—Ä–µ–∫–µ—Ä–∞</h3>
        <p id="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</p>
        <p><strong>–°–ª–µ–¥—É—é—â–∏–π heartbeat —á–µ—Ä–µ–∑:</strong> <span id="countdown">--</span> —Å–µ–∫</p>
    </div>

    <div class="stats">
        <div class="stat-card">
            <div class="stat-number" id="heartbeat-count">0</div>
            <div class="stat-label">Heartbeats –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="success-count">0</div>
            <div class="stat-label">–£—Å–ø–µ—à–Ω—ã—Ö</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="error-count">0</div>
            <div class="stat-label">–û—à–∏–±–æ–∫</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="uptime">00:00</div>
            <div class="stat-label">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</div>
        </div>
    </div>

    <div class="button-group">
        <button onclick="sendManualHeartbeat()" class="success">üì° –û—Ç–ø—Ä–∞–≤–∏—Ç—å Heartbeat</button>
        <button onclick="sendOfflineSignal()" class="danger">üò¥ –û—Ç–ø—Ä–∞–≤–∏—Ç—å Offline</button>
        <button onclick="checkUserStatus()">üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
        <button onclick="clearLogs()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        <button onclick="toggleTracker()">‚èØÔ∏è –í–∫–ª/–í—ã–∫–ª —Ç—Ä–µ–∫–µ—Ä</button>
    </div>

    <div class="console-command">
        <strong>üí° –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:</strong><br>
        <code>tail -f logs/application.log | grep "Activity\|Heartbeat\|–æ–Ω–ª–∞–π–Ω\|–æ—Ñ–ª–∞–π–Ω"</code>
    </div>

    <div class="log-panel" id="log-panel">
        <div class="log-entry log-info">üöÄ –õ–æ–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∂–µ–Ω. –û–∂–∏–¥–∞–Ω–∏–µ events...</div>
    </div>
</div>

<!-- Activity Tracker Script -->
<script>
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    let stats = {
        heartbeatCount: 0,
        successCount: 0,
        errorCount: 0,
        startTime: Date.now()
    };

    let trackerEnabled = true;
    let heartbeatTimer = null;
    let countdownTimer = null;
    let nextHeartbeatTime = 0;

    const HEARTBEAT_INTERVAL = 30 * 1000; // 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–≤–º–µ—Å—Ç–æ 2 –º–∏–Ω—É—Ç)

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    function addLog(message, type = 'info') {
        const logPanel = document.getElementById('log-panel');
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry log-${type}`;
        logEntry.innerHTML = `[${timestamp}] ${message}`;
        logPanel.appendChild(logEntry);
        logPanel.scrollTop = logPanel.scrollHeight;

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
        const entries = logPanel.children;
        if (entries.length > 100) {
            logPanel.removeChild(entries[0]);
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function updateStats() {
        document.getElementById('heartbeat-count').textContent = stats.heartbeatCount;
        document.getElementById('success-count').textContent = stats.successCount;
        document.getElementById('error-count').textContent = stats.errorCount;

        const uptime = Math.floor((Date.now() - stats.startTime) / 1000);
        const minutes = Math.floor(uptime / 60);
        const seconds = uptime % 60;
        document.getElementById('uptime').textContent =
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
    function updateIndicator(online = true) {
        const indicator = document.getElementById('indicator');
        const status = document.getElementById('status');

        if (online) {
            indicator.classList.remove('offline');
            status.textContent = '–¢—Ä–µ–∫–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω, heartbeat –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥';
        } else {
            indicator.classList.add('offline');
            status.textContent = '–¢—Ä–µ–∫–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
        }
    }

    // –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç
    function updateCountdown() {
        if (!trackerEnabled) {
            document.getElementById('countdown').textContent = '--';
            return;
        }

        const remaining = Math.max(0, Math.ceil((nextHeartbeatTime - Date.now()) / 1000));
        document.getElementById('countdown').textContent = remaining;
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ heartbeat
    function sendHeartbeat() {
        if (!trackerEnabled) return;

        stats.heartbeatCount++;
        addLog('üì° –û—Ç–ø—Ä–∞–≤–∫–∞ heartbeat –∑–∞–ø—Ä–æ—Å–∞...', 'info');

        fetch('/api/user/activity', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                addLog(`üìä –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`, 'info');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    stats.successCount++;
                    addLog(`‚úÖ Heartbeat —É—Å–ø–µ—à–µ–Ω! UserID: ${data.userId}`, 'success');
                    addLog(`üìÖ –í—Ä–µ–º—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: ${data.timestamp}`, 'info');
                } else {
                    addLog(`‚ùå –û—à–∏–±–∫–∞ heartbeat: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                stats.errorCount++;
                addLog(`üí• –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
                console.error('Heartbeat error:', error);
            });

        updateStats();
    }

    // –†—É—á–Ω–æ–π heartbeat
    function sendManualHeartbeat() {
        addLog('üéØ –†—É—á–Ω–æ–π heartbeat –∑–∞–ø—É—â–µ–Ω', 'info');
        sendHeartbeat();
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ offline —Å–∏–≥–Ω–∞–ª–∞
    function sendOfflineSignal() {
        addLog('üò¥ –û—Ç–ø—Ä–∞–≤–∫–∞ offline —Å–∏–≥–Ω–∞–ª–∞...', 'warning');

        fetch('/api/user/offline', {
            method: 'POST',
            credentials: 'include'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog(`‚úÖ Offline —Å–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! UserID: ${data.userId}`, 'success');
                } else {
                    addLog(`‚ùå –û—à–∏–±–∫–∞ offline: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                addLog(`üí• –û—à–∏–±–∫–∞ offline –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`, 'error');
            });
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function checkUserStatus() {
        addLog('üìä –ó–∞–ø—Ä–æ—Å —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞...', 'info');

        fetch('/api/user/status', {
            method: 'GET',
            credentials: 'include'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const status = data.isOnline ? 'üü¢ –û–ù–õ–ê–ô–ù' : 'üî¥ –û–§–õ–ê–ô–ù';
                    addLog(`üìã –°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${data.userId}: ${status}`, 'success');
                    addLog(`üìÖ –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${data.lastSeen || 'N/A'}`, 'info');
                } else {
                    addLog(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                addLog(`üí• –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞: ${error.message}`, 'error');
            });
    }

    // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
    function clearLogs() {
        const logPanel = document.getElementById('log-panel');
        logPanel.innerHTML = '<div class="log-entry log-info">üßπ –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã</div>';
    }

    // –í–∫–ª/–í—ã–∫–ª —Ç—Ä–µ–∫–µ—Ä
    function toggleTracker() {
        trackerEnabled = !trackerEnabled;

        if (trackerEnabled) {
            startTracker();
            addLog('‚ñ∂Ô∏è Activity Tracker –∑–∞–ø—É—â–µ–Ω', 'success');
        } else {
            stopTracker();
            addLog('‚è∏Ô∏è Activity Tracker –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'warning');
        }

        updateIndicator(trackerEnabled);
    }

    // –ó–∞–ø—É—Å–∫ —Ç—Ä–µ–∫–µ—Ä–∞
    function startTracker() {
        if (heartbeatTimer) clearInterval(heartbeatTimer);
        if (countdownTimer) clearInterval(countdownTimer);

        // –ü–µ—Ä–≤—ã–π heartbeat —Å—Ä–∞–∑—É
        sendHeartbeat();
        nextHeartbeatTime = Date.now() + HEARTBEAT_INTERVAL;

        // –†–µ–≥—É–ª—è—Ä–Ω—ã–µ heartbeat
        heartbeatTimer = setInterval(() => {
            sendHeartbeat();
            nextHeartbeatTime = Date.now() + HEARTBEAT_INTERVAL;
        }, HEARTBEAT_INTERVAL);

        // –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç
        countdownTimer = setInterval(updateCountdown, 1000);
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç—Ä–µ–∫–µ—Ä–∞
    function stopTracker() {
        if (heartbeatTimer) {
            clearInterval(heartbeatTimer);
            heartbeatTimer = null;
        }
        if (countdownTimer) {
            clearInterval(countdownTimer);
            countdownTimer = null;
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        addLog('üöÄ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ Activity Tracker –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
        addLog('‚öôÔ∏è –ò–Ω—Ç–µ—Ä–≤–∞–ª heartbeat: 30 —Å–µ–∫—É–Ω–¥ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)', 'info');
        addLog('üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤', 'info');

        updateIndicator(true);
        startTracker();

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        setInterval(updateStats, 1000);
    });

    // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
    window.addEventListener('beforeunload', function() {
        addLog('üëã –ó–∞–∫—Ä—ã—Ç–∏–µ –≤–∫–ª–∞–¥–∫–∏, –æ—Ç–ø—Ä–∞–≤–∫–∞ offline —Å–∏–≥–Ω–∞–ª–∞...', 'warning');

        if (navigator.sendBeacon) {
            navigator.sendBeacon('/api/user/offline', new FormData());
        }
    });

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≤–∫–ª–∞–¥–∫–∏
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            addLog('üëÅÔ∏è –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞–ª–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π', 'warning');
        } else {
            addLog('üëÅÔ∏è –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω–æ–π', 'info');
            if (trackerEnabled) {
                sendHeartbeat(); // –°—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏
            }
        }
    });
</script>
</body>
</html>