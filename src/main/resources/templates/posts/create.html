<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Создать пост</title>
</head>
<body>
<div>
  <h1>Создать новый пост</h1>

  <!-- Сообщения об ошибках -->
  <div th:if="${errorMessage}" style="color: red; margin-bottom: 10px;">
    <p th:text="${errorMessage}"></p>
  </div>

  <!-- Форма создания поста -->
  <form th:action="@{/posts/create}"
        th:object="${postCreateDto}"
        method="post"
        enctype="multipart/form-data">

    <!-- Поле для текста поста -->
    <div style="margin-bottom: 15px;">
      <label for="content">Текст поста:</label>
      <br>
      <textarea
              id="content"
              th:field="*{content}"
              rows="5"
              cols="50"
              placeholder="Поделитесь своими мыслями...">
                </textarea>

      <!-- Ошибки валидации для content -->
      <div th:if="${#fields.hasErrors('content')}" style="color: red;">
        <span th:each="error : ${#fields.errors('content')}" th:text="${error}"></span>
      </div>
    </div>

    <!-- Поле для загрузки изображения -->
    <div style="margin-bottom: 15px;">
      <label for="image">Добавить изображение (необязательно):</label>
      <br>
      <input
              type="file"
              id="image"
              th:field="*{image}"
              accept="image/jpeg,image/jpg,image/png,image/heif,image/heic">

      <!-- Ошибки валидации для image -->
      <div th:if="${#fields.hasErrors('image')}" style="color: red;">
        <span th:each="error : ${#fields.errors('image')}" th:text="${error}"></span>
      </div>

      <!-- Информация о поддерживаемых форматах -->
      <small style="color: gray;">
        Поддерживаемые форматы: JPG, JPEG, PNG, HEIF, HEIC. Максимальный размер: 10MB
      </small>
    </div>

    <!-- Кнопки -->
    <div>
      <button type="submit">Создать пост</button>
      <button type="button" onclick="history.back()">Отмена</button>
    </div>
  </form>

  <!-- Предварительный просмотр изображения -->
  <div id="imagePreview" style="margin-top: 20px; display: none;">
    <h3>Предварительный просмотр:</h3>
    <img id="preview" src="" alt="Предварительный просмотр" style="max-width: 300px; max-height: 300px;">
  </div>
</div>

<script>
  // Предварительный просмотр изображения
  document.getElementById('image').addEventListener('change', function(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('preview');
    const previewContainer = document.getElementById('imagePreview');

    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        previewContainer.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      previewContainer.style.display = 'none';
    }
  });

  // Счетчик символов для textarea
  document.getElementById('content').addEventListener('input', function() {
    const maxLength = 1000;
    const currentLength = this.value.length;

    // Создаем или обновляем счетчик
    let counter = document.getElementById('charCounter');
    if (!counter) {
      counter = document.createElement('div');
      counter.id = 'charCounter';
      counter.style.fontSize = 'small';
      counter.style.color = 'gray';
      this.parentNode.appendChild(counter);
    }

    counter.textContent = `${currentLength}/${maxLength} символов`;

    // Меняем цвет при приближении к лимиту
    if (currentLength > maxLength * 0.9) {
      counter.style.color = 'orange';
    } else if (currentLength > maxLength * 0.95) {
      counter.style.color = 'red';
    } else {
      counter.style.color = 'gray';
    }
  });
</script>
</body>
</html>