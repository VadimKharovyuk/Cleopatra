<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</title>
    <link th:href="@{/css/auth/login.css}" rel="stylesheet" type="text/css">
</head>
<body>
<div class="container">
    <h1>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h1>

    <!-- QR —Ñ–æ—Ä–º–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω) -->
    <div th:if="${token}" class="qr-form">
        <div class="info">
            üì± –í—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–ª–∏ QR-–∫–æ–¥ —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞.<br>
            –í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
        </div>

        <form id="qrLoginForm">
            <input type="hidden" id="qr-token" th:value="${token}">

            <div class="form-group">
                <label for="qr-email">Email:</label>
                <input type="email" id="qr-email" name="email" required>
            </div>

            <div class="form-group">
                <label for="qr-password">–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="qr-password" name="password" required>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="trustDevice" name="trustDevice">
                <label for="trustDevice">–ó–∞–ø–æ–º–Ω–∏—Ç—å —ç—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</label>
            </div>
            <div class="trust-info">
                –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ QR-–∫–æ–¥–∞ —Å —ç—Ç–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤—Ö–æ–¥ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º
            </div>

            <button type="submit" class="submit-btn" id="qrSubmitBtn">
                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å QR-–≤—Ö–æ–¥
            </button>

            <div class="loading" id="qrLoading">
                –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Ö–æ–¥
            </div>

            <div id="qrMessage"></div>
        </form>

        <div class="form-divider">
            <span>–∏–ª–∏</span>
        </div>
    </div>
    <!-- –û–±—ã—á–Ω–∞—è —Ñ–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
    <form th:action="@{/login}" method="post">
        <input type="hidden" th:value="${token}" name="token" th:if="${token}">

        <div class="form-group">
            <label for="username">Email:</label>
            <input type="email" id="username" name="username" required>
        </div>

        <div class="form-group">
            <label for="regular-password">–ü–∞—Ä–æ–ª—å:</label>
            <input type="password" id="regular-password" name="password" required>
        </div>

        <div class="checkbox-group">
            <input type="checkbox" id="remember-me" name="remember-me">
            <label for="remember-me">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>
        </div>

        <button type="submit" class="submit-btn">
            <span th:if="${token}">–û–±—ã—á–Ω—ã–π –≤—Ö–æ–¥</span>
            <span th:unless="${token}">–í–æ–π—Ç–∏</span>
        </button>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏ -->
        <div class="form-links">
            <!-- QR-–≤—Ö–æ–¥ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞) -->
            <div class="link-item" th:unless="${token}">
                <a th:href="@{/qr-login}" class="secondary-link">
                    <i class="fas fa-qrcode"></i>
                    –í–æ–π—Ç–∏ –ø–æ QR-–∫–æ–¥—É
                </a>
            </div>

            <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
            <div class="link-item">
                <span class="link-text">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?</span>
                <a th:href="@{/register}" class="primary-link">
                    <i class="fas fa-user-plus"></i>
                    –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </a>
            </div>

            <!-- –î–æ–º–æ–π -->
            <div class="link-item">
                <a th:href="@{/}" class="home-link">
                    <i class="fas fa-home"></i>
                    –ù–∞ –≥–ª–∞–≤–Ω—É—é
                </a>
            </div>
        </div>
    </form>
</div>



<!--    &lt;!&ndash; –û–±—ã—á–Ω–∞—è —Ñ–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ &ndash;&gt;-->
<!--    <form th:action="@{/login}" method="post">-->
<!--        <input type="hidden" th:value="${token}" name="token" th:if="${token}">-->

<!--        <div class="form-group">-->
<!--            <label for="username">Email:</label>-->
<!--            <input type="email" id="username" name="username" required>-->
<!--        </div>-->

<!--        <div class="form-group">-->
<!--            <label for="regular-password">–ü–∞—Ä–æ–ª—å:</label>-->
<!--            <input type="password" id="regular-password" name="password" required>-->
<!--        </div>-->

<!--        <div class="checkbox-group">-->
<!--            <input type="checkbox" id="remember-me" name="remember-me">-->
<!--            <label for="remember-me">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>-->
<!--        </div>-->

<!--        <button type="submit" class="submit-btn">-->
<!--            <span th:if="${token}">–û–±—ã—á–Ω—ã–π –≤—Ö–æ–¥</span>-->
<!--            <span th:unless="${token}">–í–æ–π—Ç–∏</span>-->
<!--        </button>-->

<!--        <div class="regular-login-link" th:unless="${token}">-->
<!--            <a th:href="@{/qr-login}">-->
<!--                –í–æ–π—Ç–∏ –ø–æ QR-–∫–æ–¥—É-->
<!--            </a>-->
<!--        </div>-->
<!--    </form>-->
<!--</div>-->

<script th:if="${token}">
    document.getElementById('qrLoginForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        console.log('QR Form submitted!');

        const submitBtn = document.getElementById('qrSubmitBtn');
        const loading = document.getElementById('qrLoading');
        const messageDiv = document.getElementById('qrMessage');

        submitBtn.disabled = true;
        loading.style.display = 'block';
        messageDiv.innerHTML = '';

        try {
            const formData = {
                token: document.getElementById('qr-token').value,
                email: document.getElementById('qr-email').value,
                password: document.getElementById('qr-password').value,
                trustDevice: document.getElementById('trustDevice').checked
            };

            console.log('Sending QR form data:', formData);

            const response = await fetch('/auth/qr/confirm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();
            console.log('QR Response:', result);

            if (result.success) {
                showMessage('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ! ‚úÖ<br>–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'success');
                document.getElementById('qrLoginForm').reset();
            } else {
                showMessage(result.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
            }

        } catch (error) {
            console.error('QR Login error:', error);
            showMessage('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ' + error.message, 'error');
        } finally {
            submitBtn.disabled = false;
            loading.style.display = 'none';
        }
    });


    function showMessage(text, type) {
        const messageDiv = document.getElementById('qrMessage');
        messageDiv.innerHTML = text;
        messageDiv.className = `message ${type}`;
    }

    // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ email
    document.getElementById('qr-email').focus();
</script>
</body>
</html>